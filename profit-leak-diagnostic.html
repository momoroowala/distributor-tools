<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Leak Diagnostic | Free Tool for Distributors</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-tertiary:#1a1a25;--accent:#ef4444;--accent-hover:#f87171;--accent-light:rgba(239,68,68,0.1);--accent2:#f59e0b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--border:#2a2a3a;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.6}
        .container{max-width:700px;margin:0 auto;padding:2rem}
        header{text-align:center;margin-bottom:2rem;padding-top:2rem}
        .badge{display:inline-block;background:var(--accent);color:white;padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem}
        h1{font-size:2.1rem;font-weight:700;margin-bottom:0.75rem;background:linear-gradient(135deg,var(--text-primary) 0%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .subtitle{color:var(--text-secondary);font-size:1.05rem;max-width:520px;margin:0 auto}
        .progress-container{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:1.25rem 1.5rem;margin-bottom:1.5rem}
        .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
        .progress-label{font-size:0.8rem;color:var(--text-muted)}
        .progress-count{font-size:0.8rem;color:var(--accent);font-weight:600}
        .progress-bar{height:6px;background:var(--bg-tertiary);border-radius:9999px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:9999px;transition:width 0.3s}
        /* Running Total */
        .running-total{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:1.25rem 1.5rem;margin-bottom:1.5rem;display:flex;align-items:center;justify-content:space-between}
        .running-total .label{font-size:0.85rem;color:var(--text-muted)}
        .running-total .amount{font-size:1.75rem;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums;transition:all 0.3s}
        /* Question Card */
        .q-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:2rem;display:none}
        .q-card.active{display:block;animation:slideIn 0.3s ease}
        @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
        .q-category{display:inline-block;background:var(--accent-light);color:var(--accent);padding:0.2rem 0.6rem;border-radius:0.25rem;font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem}
        .q-text{font-size:1.15rem;font-weight:600;margin-bottom:0.5rem;line-height:1.35}
        .q-hint{font-size:0.8rem;color:var(--text-muted);margin-bottom:1.25rem}
        .input-group{margin-bottom:1rem}
        .input-group label{display:block;font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.4rem;font-weight:500}
        .input-row{display:flex;align-items:stretch}
        .input-row input{flex:1;padding:0.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:0.5rem 0 0 0.5rem;color:var(--text-primary);font-size:1rem;border-right:none}
        .input-row input:focus{outline:none;border-color:var(--accent)}
        .input-row .unit{background:var(--bg-tertiary);border:1px solid var(--border);border-left:none;border-radius:0 0.5rem 0.5rem 0;padding:0 0.75rem;display:flex;align-items:center;color:var(--text-muted);font-size:0.8rem;min-width:60px;justify-content:center}
        select{width:100%;padding:0.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-size:1rem}
        select:focus{outline:none;border-color:var(--accent)}
        .nav-buttons{display:flex;gap:1rem;margin-top:1.5rem}
        .btn{flex:1;padding:0.875rem 1.25rem;border-radius:0.5rem;font-weight:600;font-size:0.95rem;cursor:pointer;transition:all 0.2s;border:none}
        .btn-primary{background:var(--accent);color:white}
        .btn-primary:hover{background:var(--accent-hover)}
        .btn-secondary{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border)}
        .btn-secondary:hover{background:var(--border);color:var(--text-primary)}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        /* Leak Reveal */
        .leak-reveal{background:var(--accent-light);border:1px solid rgba(239,68,68,0.3);border-radius:0.75rem;padding:1rem;margin-top:1rem;display:none}
        .leak-reveal.active{display:block;animation:fadeIn 0.3s ease}
        .leak-reveal .leak-amount{font-size:1.3rem;font-weight:700;color:var(--accent)}
        .leak-reveal .leak-desc{font-size:0.85rem;color:var(--text-secondary);margin-top:0.25rem}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* Results */
        .results-page{display:none}
        .results-page.active{display:block;animation:fadeIn 0.4s ease}
        .total-card{background:var(--bg-secondary);border:2px solid var(--accent);border-radius:1rem;padding:2.5rem;text-align:center;margin-bottom:2rem}
        .total-card .reveal-text{font-size:1rem;color:var(--text-secondary);margin-bottom:0.5rem}
        .total-card .total-amount{font-size:3.5rem;font-weight:700;color:var(--accent);line-height:1}
        .total-card .total-sub{font-size:1rem;color:var(--text-muted);margin-top:0.5rem}
        .total-card .total-context{color:var(--text-secondary);margin-top:1rem;font-size:0.95rem}
        .leaks-breakdown{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:2rem;margin-bottom:2rem}
        .leaks-breakdown h3{font-size:1.1rem;margin-bottom:1.25rem}
        .leak-row{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid var(--border)}
        .leak-row:last-child{border-bottom:none}
        .leak-row .name{font-size:0.9rem;color:var(--text-secondary)}
        .leak-row .val{font-size:1rem;font-weight:600;color:var(--accent)}
        .leak-bar-container{flex:1;height:8px;background:var(--bg-tertiary);border-radius:9999px;margin:0 1rem;overflow:hidden}
        .leak-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:9999px}
        /* Download Section */
        .download-section{background:linear-gradient(135deg,var(--accent-light),var(--bg-secondary));border:2px solid var(--accent);border-radius:1rem;padding:2.5rem;text-align:center;margin-bottom:2rem}
        .download-section h3{font-size:1.4rem;margin-bottom:0.5rem}
        .download-section>p{color:var(--text-secondary);margin-bottom:1.5rem}
        .download-features{display:flex;justify-content:center;gap:1.5rem;margin-bottom:1.5rem;flex-wrap:wrap}
        .download-feature{display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;color:var(--text-secondary)}
        .download-feature .icon{color:var(--success)}
        .email-form{display:flex;gap:0.75rem;max-width:450px;margin:0 auto;flex-wrap:wrap}
        .email-form input[type="email"]{flex:1;min-width:200px;padding:0.875rem 1rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-size:1rem}
        .email-form input:focus{outline:none;border-color:var(--accent)}
        .email-form .btn{flex:none;min-width:180px}
        .download-complete{display:none;color:var(--success);padding:1rem;font-size:1rem}
        .download-complete.active{display:block}
        footer{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.875rem}
        footer a{color:var(--accent);text-decoration:none}
        @media(max-width:640px){.container{padding:1rem}h1{font-size:1.65rem}.total-card .total-amount{font-size:2.5rem}.running-total .amount{font-size:1.3rem}}
    </style>
</head>
<body>
<div class="container">
    <header>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
        <span class="badge">Free Diagnostic</span>
        <h1>The $100K You Don't Know You're Losing</h1>
        <p class="subtitle">Answer 8 questions about your operations. We'll calculate exactly how much profit is silently leaking from your distribution business.</p>
    </header>
    <div class="progress-container" id="progressContainer">
        <div class="progress-header">
            <span class="progress-label">Diagnostic Progress</span>
            <span class="progress-count"><span id="currentQ">1</span> of <span id="totalQ">8</span></span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:12.5%"></div></div>
    </div>
    <div class="running-total" id="runningTotal">
        <span class="label">💸 Estimated Annual Profit Leakage</span>
        <span class="amount" id="runningAmount">$0</span>
    </div>
    <div id="questionsContainer"></div>
    <div class="results-page" id="resultsPage">
        <div class="total-card">
            <div class="reveal-text">Your distribution business is silently losing an estimated</div>
            <div class="total-amount" id="finalTotal">$0</div>
            <div class="total-sub">per year</div>
            <div class="total-context" id="totalContext"></div>
        </div>
        <div class="leaks-breakdown">
            <h3>Where It's Going</h3>
            <div id="leaksBreakdown"></div>
        </div>
        <div class="download-section" id="downloadSection">
            <h3>📄 Get Your Full Profit Recovery Plan</h3>
            <p>Download a detailed PDF showing exactly how to plug each leak, with implementation timelines and projected ROI.</p>
            <div class="download-features">
                <div class="download-feature"><span class="icon">✓</span><span>Fix-by-fix action plan</span></div>
                <div class="download-feature"><span class="icon">✓</span><span>ROI per improvement</span></div>
                <div class="download-feature"><span class="icon">✓</span><span>Priority ranking</span></div>
            </div>
            <form class="email-form" id="emailForm" onsubmit="handleDownload(event)" style="flex-direction:column;align-items:stretch;max-width:420px;margin:0 auto;gap:0.5rem;">
                <div style="display:flex;gap:0.5rem;width:100%;">
                    <input type="text" id="userFirst" placeholder="First name" required style="flex:1;padding:0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:0.5rem;color:var(--text);font-size:0.95rem;">
                    <input type="text" id="userLast" placeholder="Last name" required style="flex:1;padding:0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:0.5rem;color:var(--text);font-size:0.95rem;">
                </div>
                <input type="email" id="userEmail" placeholder="Work email" required style="width:100%;padding:0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:0.5rem;color:var(--text);font-size:0.95rem;">
                <button type="submit" class="btn btn-primary">Download PDF Report</button>
            </form>
            <div class="download-complete" id="downloadComplete">✓ Report downloaded! Check your downloads folder.</div>
        </div>
    </div>
    <footer><p>Built by <a href="#">Mo Roowala</a> | AI Automation for Distributors</p></footer>
</div>
<script>
const { jsPDF } = window.jspdf;

const steps = [
    {
        category: "Revenue",
        question: "What is your approximate annual revenue?",
        hint: "This helps us calculate dollar amounts specific to your business.",
        inputs: [
            { id: "revenue", label: "Annual Revenue", type: "number", placeholder: "e.g., 25000000", unit: "$" }
        ],
        calc: (vals) => ({ leak: 0, label: "Baseline", desc: "" })
    },
    {
        category: "Pricing",
        question: "How do your sales reps handle pricing?",
        hint: "Inconsistent pricing is the #1 profit leak in distribution. A 1% price reduction can wipe out 11% of profit.",
        inputs: [
            { id: "pricingMethod", label: "Primary pricing method", type: "select", options: [
                { value: "gut", text: "Reps decide based on gut/experience" },
                { value: "lists", text: "Price lists exist but lots of exceptions" },
                { value: "system", text: "System-driven with clear rules" }
            ]},
            { id: "overridesPerWeek", label: "Price overrides or exceptions per week", type: "number", placeholder: "e.g., 15", unit: "/week" }
        ],
        calc: (vals) => {
            const rev = parseFloat(vals.revenue) || 0;
            const method = vals.pricingMethod;
            const overrides = parseFloat(vals.overridesPerWeek) || 0;
            let leakPct = method === 'gut' ? 0.01 : method === 'lists' ? 0.006 : 0.002;
            leakPct += (overrides * 0.0003);
            const leak = Math.round(rev * leakPct);
            return { leak, label: "Pricing Inconsistency", desc: `${overrides} overrides/week at ~${(leakPct*100).toFixed(2)}% revenue impact` };
        }
    },
    {
        category: "Order Processing",
        question: "How many orders does your team process per day, and how?",
        hint: "Manual order entry costs $5-15 per order in labor. Errors cost 10-20x more to fix.",
        inputs: [
            { id: "ordersPerDay", label: "Orders processed per day", type: "number", placeholder: "e.g., 50", unit: "/day" },
            { id: "manualPct", label: "% entered manually (from email/phone)", type: "number", placeholder: "e.g., 70", unit: "%" },
            { id: "errorRate", label: "Estimated error rate", type: "number", placeholder: "e.g., 3", unit: "%" }
        ],
        calc: (vals) => {
            const orders = parseFloat(vals.ordersPerDay) || 0;
            const manual = (parseFloat(vals.manualPct) || 0) / 100;
            const errorRate = (parseFloat(vals.errorRate) || 0) / 100;
            const manualCostPerOrder = 5;
            const errorCostPerOrder = 85;
            const yearlyOrders = orders * 260;
            const manualCost = Math.round(yearlyOrders * manual * manualCostPerOrder);
            const errorCost = Math.round(yearlyOrders * errorRate * errorCostPerOrder);
            const leak = manualCost + errorCost;
            return { leak, label: "Order Processing Waste", desc: `${Math.round(yearlyOrders*manual).toLocaleString()} manual entries + ${Math.round(yearlyOrders*errorRate).toLocaleString()} errors/year` };
        }
    },
    {
        category: "Quoting",
        question: "How long does it take to turn around a quote?",
        hint: "Every hour of delay on a quote reduces win rate by 2-5%. Speed to quote is speed to revenue.",
        inputs: [
            { id: "quotesPerWeek", label: "Quotes sent per week", type: "number", placeholder: "e.g., 30", unit: "/week" },
            { id: "quoteHours", label: "Average hours to send a quote", type: "number", placeholder: "e.g., 4", unit: "hours" },
            { id: "avgQuoteValue", label: "Average quote value", type: "number", placeholder: "e.g., 5000", unit: "$" }
        ],
        calc: (vals) => {
            const quotes = parseFloat(vals.quotesPerWeek) || 0;
            const hours = parseFloat(vals.quoteHours) || 0;
            const value = parseFloat(vals.avgQuoteValue) || 0;
            const lostPct = Math.min(hours * 0.02, 0.15);
            const yearlyQuotes = quotes * 52;
            const leak = Math.round(yearlyQuotes * value * lostPct * 0.15);
            return { leak, label: "Slow Quote Response", desc: `${hours}hr avg turnaround losing ~${(lostPct*100).toFixed(0)}% of winnable deals` };
        }
    },
    {
        category: "Inventory",
        question: "How accurate is your inventory, and how often do you have stockouts?",
        hint: "The average distributor has 20-30% excess inventory and 5-10% stockout rate.",
        inputs: [
            { id: "inventoryValue", label: "Total inventory value", type: "number", placeholder: "e.g., 3000000", unit: "$" },
            { id: "stockoutPct", label: "Estimated stockout rate (% of orders)", type: "number", placeholder: "e.g., 5", unit: "%" },
            { id: "excessPct", label: "Estimated excess/dead stock (%)", type: "number", placeholder: "e.g., 15", unit: "%" }
        ],
        calc: (vals) => {
            const rev = parseFloat(vals.revenue) || 0;
            const inv = parseFloat(vals.inventoryValue) || 0;
            const stockout = (parseFloat(vals.stockoutPct) || 0) / 100;
            const excess = (parseFloat(vals.excessPct) || 0) / 100;
            const stockoutLoss = Math.round(rev * stockout * 0.15);
            const carryingCost = Math.round(inv * excess * 0.25);
            const leak = stockoutLoss + carryingCost;
            return { leak, label: "Inventory Mismanagement", desc: `$${stockoutLoss.toLocaleString()} lost sales + $${carryingCost.toLocaleString()} carrying cost` };
        }
    },
    {
        category: "Customer Retention",
        question: "What does customer churn look like for you?",
        hint: "Acquiring a new customer costs 5-7x more than retaining one. Most distributors don't track churn.",
        inputs: [
            { id: "totalCustomers", label: "Active customers", type: "number", placeholder: "e.g., 200", unit: "" },
            { id: "churnPct", label: "% of customers lost per year", type: "number", placeholder: "e.g., 10", unit: "%" },
            { id: "avgCustomerValue", label: "Average annual customer value", type: "number", placeholder: "e.g., 50000", unit: "$" }
        ],
        calc: (vals) => {
            const customers = parseFloat(vals.totalCustomers) || 0;
            const churn = (parseFloat(vals.churnPct) || 0) / 100;
            const acv = parseFloat(vals.avgCustomerValue) || 0;
            const preventable = 0.2;
            const leak = Math.round(customers * churn * acv * preventable);
            return { leak, label: "Preventable Customer Churn", desc: `${Math.round(customers*churn)} customers lost/year, ~30% preventable with automation` };
        }
    },
    {
        category: "Labor",
        question: "How much time does your team spend on tasks that should be automated?",
        hint: "The average distributor employee spends 40% of their time on repetitive manual tasks.",
        inputs: [
            { id: "employeeCount", label: "Number of office/admin employees", type: "number", placeholder: "e.g., 12", unit: "" },
            { id: "avgSalary", label: "Average annual salary", type: "number", placeholder: "e.g., 55000", unit: "$" },
            { id: "manualTimePct", label: "% of time on repetitive manual work", type: "number", placeholder: "e.g., 35", unit: "%" }
        ],
        calc: (vals) => {
            const count = parseFloat(vals.employeeCount) || 0;
            const salary = parseFloat(vals.avgSalary) || 0;
            const manual = (parseFloat(vals.manualTimePct) || 0) / 100;
            const automatable = 0.4;
            const leak = Math.round(count * salary * manual * automatable);
            return { leak, label: "Wasted Labor Hours", desc: `${count} employees x ${(manual*100).toFixed(0)}% manual time x 60% automatable` };
        }
    },
    {
        category: "Supplier",
        question: "How do you handle supplier price changes?",
        hint: "Most distributors take 2-4 weeks to pass through supplier increases. Every day of delay erodes margin.",
        inputs: [
            { id: "priceChangesYear", label: "Supplier price changes per year", type: "number", placeholder: "e.g., 50", unit: "/year" },
            { id: "daysToUpdate", label: "Average days to update your prices", type: "number", placeholder: "e.g., 14", unit: "days" },
            { id: "avgChangeImpact", label: "Avg revenue affected per change", type: "number", placeholder: "e.g., 100000", unit: "$" }
        ],
        calc: (vals) => {
            const changes = parseFloat(vals.priceChangesYear) || 0;
            const days = parseFloat(vals.daysToUpdate) || 0;
            const impact = parseFloat(vals.avgChangeImpact) || 0;
            const dailyMarginLoss = 0.0003;
            const leak = Math.round(changes * days * impact * dailyMarginLoss);
            return { leak, label: "Slow Price Pass-Through", desc: `${days} day avg delay across ${changes} changes/year` };
        }
    }
];

let currentStep = 0;
let allValues = {};
let leaks = [];
let runningLeak = 0;

function init() {
    document.getElementById('totalQ').textContent = steps.length;
    renderStep(0);
}

function renderStep(idx) {
    const s = steps[idx];
    const container = document.getElementById('questionsContainer');
    let html = `<div class="q-card active">
        <span class="q-category">${s.category}</span>
        <h2 class="q-text">${s.question}</h2>
        <p class="q-hint">${s.hint}</p>`;

    s.inputs.forEach(inp => {
        html += `<div class="input-group"><label for="${inp.id}">${inp.label}</label>`;
        if (inp.type === 'select') {
            html += `<select id="${inp.id}">`;
            inp.options.forEach(o => {
                const sel = allValues[inp.id] === o.value ? 'selected' : '';
                html += `<option value="${o.value}" ${sel}>${o.text}</option>`;
            });
            html += `</select>`;
        } else {
            const val = allValues[inp.id] || '';
            if (inp.unit && inp.unit !== '') {
                html += `<div class="input-row"><input type="number" id="${inp.id}" placeholder="${inp.placeholder}" value="${val}" min="0" step="any">
                    <span class="unit">${inp.unit}</span></div>`;
            } else {
                html += `<div class="input-row"><input type="number" id="${inp.id}" placeholder="${inp.placeholder}" value="${val}" min="0" step="any">
                    <span class="unit">#</span></div>`;
            }
        }
        html += `</div>`;
    });

    html += `<div class="leak-reveal" id="leakReveal"></div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="prevStep()" ${idx===0?'disabled':''}>← Back</button>
            <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">${idx===steps.length-1?'See Full Results':'Next →'}</button>
        </div></div>`;

    container.innerHTML = html;
    document.getElementById('currentQ').textContent = idx + 1;
    document.getElementById('progressFill').style.width = ((idx+1)/steps.length*100) + '%';
}

function saveCurrentInputs() {
    const s = steps[currentStep];
    s.inputs.forEach(inp => {
        const el = document.getElementById(inp.id);
        if (el) allValues[inp.id] = el.value;
    });
}

function nextStep() {
    saveCurrentInputs();

    // Calculate leak for current step
    if (currentStep > 0 || steps[currentStep].calc) {
        const result = steps[currentStep].calc(allValues);
        if (result.leak > 0) {
            leaks[currentStep] = result;
            recalcTotal();
        }
    }

    if (currentStep < steps.length - 1) {
        currentStep++;
        renderStep(currentStep);
    } else {
        showResults();
    }
}

function prevStep() {
    saveCurrentInputs();
    if (currentStep > 0) {
        currentStep--;
        renderStep(currentStep);
    }
}

function recalcTotal() {
    runningLeak = leaks.reduce((sum, l) => sum + (l ? l.leak : 0), 0);
    const el = document.getElementById('runningAmount');
    el.textContent = '$' + runningLeak.toLocaleString();
    el.style.transform = 'scale(1.1)';
    setTimeout(() => el.style.transform = 'scale(1)', 200);
}

function showResults() {
    document.getElementById('questionsContainer').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'none';
    document.getElementById('runningTotal').style.display = 'none';
    document.getElementById('resultsPage').classList.add('active');

    const total = runningLeak;
    document.getElementById('finalTotal').textContent = '$' + total.toLocaleString();

    const rev = parseFloat(allValues.revenue) || 1;
    const pctOfRev = ((total / rev) * 100).toFixed(1);
    const perMonth = Math.round(total / 12).toLocaleString();
    const perDay = Math.round(total / 365).toLocaleString();
    document.getElementById('totalContext').innerHTML =
        `That's <strong>${pctOfRev}% of your revenue</strong>. $${perMonth} per month. $${perDay} every single day. Most of it is recoverable.`;

    // Breakdown
    const validLeaks = leaks.filter(l => l && l.leak > 0).sort((a, b) => b.leak - a.leak);
    const maxLeak = validLeaks[0]?.leak || 1;
    document.getElementById('leaksBreakdown').innerHTML = validLeaks.map(l => `
        <div class="leak-row">
            <span class="name" style="min-width:140px">${l.label}</span>
            <div class="leak-bar-container"><div class="leak-bar" style="width:${(l.leak/maxLeak*100)}%"></div></div>
            <span class="val">$${l.leak.toLocaleString()}</span>
        </div>
    `).join('');
}

function handleDownload(e) {
    e.preventDefault();
    const firstName = document.getElementById('userFirst').value.trim();
    const lastName = document.getElementById('userLast').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    if(!firstName||!lastName||!email) return;
    fetch('https://script.google.com/macros/s/AKfycbxH-0F_yuJve8Bvzf1WWqYc5Z0ptXRRktVCmLEEa-7Dbs3ear7cNESr6-Bmm8mQIJaZ/exec',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({name:firstName+' '+lastName,email:email,tool:'Profit Leak Diagnostic',_subject:'New Lead: '+firstName+' '+lastName+' - Profit Leak Diagnostic',message:firstName+' '+lastName+' ('+email+') completed the Profit Leak Diagnostic and downloaded their PDF report.'})}).catch(function(){});
    const leads = JSON.parse(localStorage.getItem('profitleak_leads') || '[]');
    leads.push({ email, timestamp: new Date().toISOString(), total: runningLeak, leaks, inputs: allValues });
    localStorage.setItem('profitleak_leads', JSON.stringify(leads));
    generatePDF(email);
    document.getElementById('emailForm').style.display = 'none';
    document.getElementById('downloadComplete').classList.add('active');
}

function generatePDF(email) {
    const doc = new jsPDF();
    const pw = doc.internal.pageSize.getWidth();
    const ph = doc.internal.pageSize.getHeight();
    const m = 20, cw = pw - 2*m;
    let y = 0;

    // Design system - Material Design
    const C = {
        bg: [241, 243, 244], card: [255, 255, 255], border: [218, 220, 224],
        text: [32, 33, 36], textMid: [95, 99, 104], textLight: [128, 134, 139],
        white: [255, 255, 255], shadow: [232, 234, 237],
        blue: [26, 115, 232], red: [217, 48, 37], yellow: [249, 171, 0], 
        green: [30, 142, 62], purple: [161, 66, 244], amber: [210, 145, 30]
    };

    const txt = (t,sz,st='normal',c=C.text) => { doc.setFontSize(sz); doc.setFont('helvetica',st); doc.setTextColor(...c); };
    const fill = (c) => doc.setFillColor(...c);
    const stroke = (c) => doc.setDrawColor(...c);
    
    const cp = (n=25) => { if(y+n>265){newPage(); return true;} return false; };

    const newPage = () => {
        doc.addPage();
        fill(C.bg); doc.rect(0,0,pw,ph,'F');
        fill(C.red); doc.rect(0,0,pw,1.5,'F');
        y = 20;
    };

    const card = (x,yc,w,h,opts={}) => {
        const r = opts.radius || 2;
        fill(C.shadow); doc.roundedRect(x+0.5,yc+0.5,w,h,r,r,'F');
        stroke(C.border); doc.setLineWidth(0.2);
        fill(C.card); doc.roundedRect(x,yc,w,h,r,r,'FD');
        if(opts.accent) { fill(opts.accent); doc.roundedRect(x,yc,3,h,r,0,'F'); doc.rect(x+1.5,yc,1.5,h,'F'); }
    };

    const secTitle = (title,yy,color=C.red) => {
        txt(title,12,'bold',C.text); doc.text(title,m,yy+7);
        fill(color); doc.rect(m,yy+10,25,1.5,'F');
        return yy+18;
    };

    // =============================
    // PAGE 1: COVER
    // =============================
    fill(C.bg); doc.rect(0,0,pw,ph,'F');
    fill(C.card); stroke(C.border); doc.roundedRect(0,-10,pw,95,0,0,'FD');
    fill(C.red); doc.circle(pw/2,22,8,'F');
    txt('A',12,'bold',C.white); doc.text('A',pw/2,25.5,{align:'center'});

    txt('PROFIT LEAK DIAGNOSTIC',22,'bold',C.text); doc.text('PROFIT LEAK DIAGNOSTIC',pw/2,48,{align:'center'});
    txt('Your Personalized Recovery Plan',11,'normal',C.textMid); doc.text('Your Personalized Recovery Plan',pw/2,58,{align:'center'});

    fill(C.bg); doc.roundedRect(pw/2-50,68,100,10,5,5,'F');
    txt(new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}),8,'bold',C.textMid);
    doc.text(new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}),pw/2,74.5,{align:'center'});

    y = 105;

    // Estimated leakage card
    card(m,y,cw,48,{accent:C.red});
    txt('TOTAL ESTIMATED ANNUAL PROFIT LEAKAGE',9,'bold',C.red); doc.text('TOTAL ESTIMATED ANNUAL PROFIT LEAKAGE',m+cw/2,y+15,{align:'center'});
    txt('$' + runningLeak.toLocaleString(),32,'bold',C.red); doc.text('$' + runningLeak.toLocaleString(),m+cw/2,y+32,{align:'center'});
    const rev = parseFloat(allValues.revenue) || 1;
    txt(`${((runningLeak/rev)*100).toFixed(1)}% of your annual revenue is leaking`,10,'normal',C.textMid);
    doc.text(`${((runningLeak/rev)*100).toFixed(1)}% of your annual revenue is leaking`,m+cw/2,y+42,{align:'center'});
    y += 65;

    // Breakdown metrics
    const metW = (cw-10)/3;
    const mets = [
        { val:'$'+Math.round(runningLeak/12).toLocaleString(), label:'PER MONTH', color:C.red },
        { val:'$'+Math.round(runningLeak/365).toLocaleString(), label:'PER DAY', color:C.amber },
        { val:((runningLeak/rev)*100).toFixed(1)+'%', label:'OF REVENUE', color:C.purple }
    ];
    mets.forEach((mt,i) => {
        const x = m + i*(metW+5);
        card(x,y,metW,34,{accent:mt.color});
        txt(mt.val,16,'bold',mt.color); doc.text(mt.val,x+metW/2,y+16,{align:'center'});
        txt(mt.label,7,'bold',C.text); doc.text(mt.label,x+metW/2,y+24,{align:'center'});
    });
    y += 50;

    // Impact Cards breakdown
    y = secTitle('WHERE YOUR PROFIT IS LEAKING', y);
    const validLeaks = leaks.filter(l=>l&&l.leak>0).sort((a,b)=>b.leak-a.leak);
    const maxLeak = validLeaks[0]?.leak || 1;

    validLeaks.forEach((l,li) => {
        cp(30);
        card(m,y,cw,22);
        // Rank circle
        fill(C.red); doc.circle(m+12,y+11,6,'F');
        txt((li+1).toString(),10,'bold',C.white); doc.text((li+1).toString(),m+12,y+14.5,{align:'center'});

        // Title and description
        txt(l.label,10,'bold',C.text); doc.text(l.label,m+25,y+10);
        txt(l.desc,8,'normal',C.textMid);
        const descL = doc.splitTextToSize(l.desc, cw-80);
        doc.text(descL,m+25,y+15);

        // Dollar pill
        fill(C.red); doc.roundedRect(pw-m-45,y+6,35,10,5,5,'F');
        txt('$'+l.leak.toLocaleString(),9,'bold',C.white); doc.text('$'+l.leak.toLocaleString(),pw-m-27.5,y+12.5,{align:'center'});
        
        y += 28;
    });

    // =============================
    // PAGE 2+: RECOVERY PLANS
    // =============================
    newPage();
    y = secTitle('DETAILED RECOVERY PLAN', y);

    const fixes = {
        "Pricing Inconsistency": { priority:"CRITICAL", impact:"1-3% revenue recovery", steps:["Audit last 90 days of quotes.","Set margin floors per category.","Automate matrix in ERP.","Establish approval workflows."] },
        "Order Processing Waste": { priority:"HIGH", impact:"50% labor reduction", steps:["Time-study order entry.","Automate standard orders.","Launch customer portal.","Implement error validation."] },
        "Slow Quote Response": { priority:"HIGH", impact:"20% higher win rate", steps:["Measure turnaround time.","Create quote templates.","Enable auto-pricing tools.","Set 24h response targets."] },
        "Inventory Mismanagement": { priority:"HIGH", impact:"30% less dead stock", steps:["Run ABC analysis.","Set reorder alerts.","Liquidate slow movers.","Cycle count A-items."] },
        "Preventable Customer Churn": { priority:"MEDIUM", impact:"25-95% more profit", steps:["Identify 'silent churn' list.","Call top 10 churned leads.","Set 'at risk' alerts.","Quarterly account reviews."] },
        "Wasted Labor Hours": { priority:"MEDIUM", impact:"20% more efficiency", steps:["Survey team on time drains.","Automate repetitive data tasks.","Deploy RPA for data entry.","Free up sales capacity."] },
        "Slow Price Pass-Through": { priority:"MEDIUM", impact:"Margin protection", steps:["Create price change playbook.","Monitor supplier updates.","Auto-calculate adjustments.","Automate notifications."] }
    };

    validLeaks.forEach((leak, idx) => {
        const fix = fixes[leak.label];
        if(!fix) return;
        cp(85);
        const col = fix.priority==="CRITICAL"?C.red:fix.priority==="HIGH"?C.amber:C.blue;
        card(m,y,cw,75,{accent:col});
        txt(`${idx+1}. ${leak.label.toUpperCase()}`,10,'bold',col); doc.text(`${idx+1}. ${leak.label.toUpperCase()}`,m+12,y+12);
        txt(`Impact: ${fix.impact}`,8,'bold',C.textMid); doc.text(`Impact: ${fix.impact}`,pw-m-12,y+12,{align:'right'});
        
        txt('PRIORITY:',8,'bold',C.text); doc.text('PRIORITY:',m+12,y+24);
        txt(fix.priority,9,'bold',col); doc.text(fix.priority,m+35,y+24);

        let sY = y+38;
        fix.steps.forEach(s => {
            fill(col); doc.circle(m+15,sY,1, 'F');
            txt(s,9,'normal',C.text); doc.text(s,m+20,sY+2);
            sY += 8;
        });
        y += 90;
    });

    // =============================
    // FINAL PAGES: ROADMAP + CTA
    // =============================
    newPage();
    y = secTitle('90-DAY PROFIT RECOVERY ROADMAP', y);
    const phases = [
        { t:'DAYS 1-14: QUICK WINS', c:C.green, items:['Set floor prices for top 50 SKUs.','Survey team on time-wasters.','Audit pricing consistency.'] },
        { t:'DAYS 15-30: FOUNDATIONS', c:C.amber, items:['Build pricing matrix rules.','Set reorder points for A-items.','Create quote templates.'] },
        { t:'DAYS 31-60: AUTOMATION', c:C.blue, items:['Configure ERP price module.','Deploy inventory alerts.','Launch order validation.'] },
        { t:'DAYS 61-90: OPTIMIZATION', c:C.purple, items:['Review margin expansion.','Fine-tune auto-rules.','Calculate recovered profit.'] }
    ];

    phases.forEach((p) => {
        cp(45);
        fill(p.c); doc.roundedRect(m,y,cw,10,2,2,'F');
        txt(p.t,9,'bold',C.white); doc.text(p.t,m+cw/2,y+7,{align:'center'});
        y += 15;
        p.items.forEach(it => {
            fill(p.c); doc.circle(m+5,y+2,1,'F');
            txt(it,9,'normal',C.text); doc.text(it,m+10,y+4);
            y += 8;
        });
        y += 5;
    });

    y += 20;
    cp(65);
    stroke(C.red); doc.setLineWidth(1);
    fill(C.white); doc.roundedRect(m,y,cw,45,3,3,'FD');
    txt("LET'S RECOVER YOUR PROFIT",14,'bold',C.text); doc.text("LET'S RECOVER YOUR PROFIT",pw/2,y+15,{align:'center'});
    txt(`You've identified $${runningLeak.toLocaleString()} in annual profit leakage. Let's get it back.`,9,'normal',C.textMid);
    doc.text(`You've identified $${runningLeak.toLocaleString()} in annual profit leakage. Let's get it back.`,pw/2,y+24,{align:'center'});
    txt('mo@deeplineop.ai',12,'bold',C.red); doc.text('mo@deeplineop.ai',pw/2,y+36,{align:'center'});

    // Footer
    const pc = doc.internal.getNumberOfPages();
    for(let i=1;i<=pc;i++){
        doc.setPage(i);
        fill(C.white); stroke(C.border); doc.rect(0,ph-12,pw,12,'FD');
        txt('Deep Line Operations | AI Automation for Distributors',7,'normal',C.textMid);
        doc.text('Deep Line Operations | AI Automation for Distributors',m,ph-5);
        txt(`Page ${i} of ${pc}`,7,'normal',C.textMid);
        doc.text(`Page ${i} of ${pc}`,pw-m,ph-5,{align:'right'});
    }
    doc.save('Profit-Leak-Diagnostic-Report.pdf');
}


init();
</script>
<!-- Navigation Menu --><div id="nav-menu" style="position:fixed;top:16px;right:16px;z-index:10000;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;">
    <button id="nav-toggle" style="background:#12121a;border:1px solid #2a2a3a;color:#f1f5f9;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.5);font-size:14px;">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><rect y="3" width="18" height="2" rx="1" fill="#f1f5f9"/><rect y="8" width="18" height="2" rx="1" fill="#f1f5f9"/><rect y="13" width="18" height="2" rx="1" fill="#f1f5f9"/></svg>
        Tools
    </button>
    <div id="nav-content" style="display:none;position:absolute;top:48px;right:0;background:#12121a;border:1px solid #2a2a3a;border-radius:12px;width:270px;padding:8px;box-shadow:0 8px 24px rgba(0,0,0,0.7);">
        <a href="index.html" style="display:flex;align-items:center;gap:10px;padding:10px 12px;color:#f1f5f9;text-decoration:none;border-radius:6px;font-size:14px;border-left:3px solid #6366f1;background:rgba(99,102,241,0.08);margin-bottom:4px;">
            <img src="logo-icon.png" alt="" style="height:18px;width:18px;object-fit:contain;">
            <strong>All Tools</strong>
        </a>
        <div style="height:1px;background:#2a2a3a;margin:6px 4px;"></div>
        <a href="ai-readiness-scorecard.html" class="nav-link" data-color="#a855f7" style="display:flex;align-items:center;gap:10px;padding:9px 12px;color:#94a3b8;text-decoration:none;border-radius:6px;font-size:13px;">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><rect x="1" y="1" width="16" height="16" rx="3" stroke="#a855f7" stroke-width="1.5"/><path d="M5 12V8M9 12V5M13 12V9" stroke="#a855f7" stroke-width="2" stroke-linecap="round"/></svg>
            AI Readiness Scorecard
        </a>
        <a href="profit-leak-diagnostic.html" class="nav-link" data-color="#ef4444" style="display:flex;align-items:center;gap:10px;padding:9px 12px;color:#94a3b8;text-decoration:none;border-radius:6px;font-size:13px;">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="7.5" stroke="#ef4444" stroke-width="1.5"/><path d="M9 5v5l3 2" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round"/><path d="M12 3l2-1M6 3L4 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round"/></svg>
            Profit Leak Diagnostic
        </a>
        <a href="ceo-time-audit.html" class="nav-link" data-color="#f59e0b" style="display:flex;align-items:center;gap:10px;padding:9px 12px;color:#94a3b8;text-decoration:none;border-radius:6px;font-size:13px;">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><rect x="2" y="3" width="14" height="12" rx="2" stroke="#f59e0b" stroke-width="1.5"/><path d="M2 7h14M6 3v-1M12 3v-1" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round"/><rect x="5" y="9" width="2" height="2" rx=".5" fill="#f59e0b"/><rect x="8" y="9" width="2" height="2" rx=".5" fill="#f59e0b"/></svg>
            CEO Time Audit
        </a>
        <a href="business-dependency.html" class="nav-link" data-color="#3b82f6" style="display:flex;align-items:center;gap:10px;padding:9px 12px;color:#94a3b8;text-decoration:none;border-radius:6px;font-size:13px;">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 2l6 4v6l-6 4-6-4V6l6-4z" stroke="#3b82f6" stroke-width="1.5" stroke-linejoin="round"/><circle cx="9" cy="9" r="2" fill="#3b82f6"/></svg>
            Business Dependency
        </a>
        <a href="rfq-parser.html" class="nav-link" data-color="#06b6d4" style="display:flex;align-items:center;gap:10px;padding:9px 12px;color:#94a3b8;text-decoration:none;border-radius:6px;font-size:13px;">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><rect x="3" y="1" width="12" height="16" rx="2" stroke="#06b6d4" stroke-width="1.5"/><path d="M6 5h6M6 8h6M6 11h4" stroke="#06b6d4" stroke-width="1.2" stroke-linecap="round"/></svg>
            RFQ Parser
        </a>
        <a href="reorder-calculator.html" class="nav-link" data-color="#22c55e" style="display:flex;align-items:center;gap:10px;padding:9px 12px;color:#94a3b8;text-decoration:none;border-radius:6px;font-size:13px;">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><rect x="2" y="6" width="14" height="10" rx="2" stroke="#22c55e" stroke-width="1.5"/><path d="M6 6V4a3 3 0 016 0v2" stroke="#22c55e" stroke-width="1.5"/><circle cx="9" cy="11" r="1.5" fill="#22c55e"/></svg>
            Reorder Calculator
        </a>
    </div>
</div>
<script>
(function(){
    var tgl=document.getElementById('nav-toggle'),cnt=document.getElementById('nav-content');
    if(!tgl||!cnt)return;
    tgl.onclick=function(e){e.stopPropagation();var v=cnt.style.display==='block';cnt.style.display=v?'none':'block';tgl.style.background=v?'#12121a':'#1a1a25';};
    document.addEventListener('click',function(){cnt.style.display='none';tgl.style.background='#12121a';});
    cnt.onclick=function(e){e.stopPropagation();};
    var links=document.querySelectorAll('.nav-link');
    links.forEach(function(l){
        l.onmouseenter=function(){l.style.background='rgba(255,255,255,0.06)';l.style.color='#f1f5f9';};
        l.onmouseleave=function(){if(!l.classList.contains('nav-active')){l.style.background='';l.style.color='#94a3b8';}};
    });
    var cur=window.location.pathname.split('/').pop()||'index.html';
    document.querySelectorAll('#nav-content a').forEach(function(a){
        if(a.getAttribute('href')===cur||(cur===''&&a.getAttribute('href')==='index.html')){
            a.classList.add('nav-active');a.style.background='rgba(255,255,255,0.1)';a.style.color='#fff';a.style.fontWeight='600';
        }
    });
})();
</script>
</body>
</html>
