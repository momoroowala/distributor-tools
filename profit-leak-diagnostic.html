<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Leak Diagnostic | Free Tool for Distributors</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-tertiary:#1a1a25;--accent:#ef4444;--accent-hover:#f87171;--accent-light:rgba(239,68,68,0.1);--accent2:#f59e0b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--border:#2a2a3a;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.6}
        .container{max-width:700px;margin:0 auto;padding:2rem}
        header{text-align:center;margin-bottom:2rem;padding-top:2rem}
        .badge{display:inline-block;background:var(--accent);color:white;padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem}
        h1{font-size:2.1rem;font-weight:700;margin-bottom:0.75rem;background:linear-gradient(135deg,var(--text-primary) 0%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .subtitle{color:var(--text-secondary);font-size:1.05rem;max-width:520px;margin:0 auto}
        .progress-container{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:1.25rem 1.5rem;margin-bottom:1.5rem}
        .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
        .progress-label{font-size:0.8rem;color:var(--text-muted)}
        .progress-count{font-size:0.8rem;color:var(--accent);font-weight:600}
        .progress-bar{height:6px;background:var(--bg-tertiary);border-radius:9999px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:9999px;transition:width 0.3s}
        /* Running Total */
        .running-total{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:1.25rem 1.5rem;margin-bottom:1.5rem;display:flex;align-items:center;justify-content:space-between}
        .running-total .label{font-size:0.85rem;color:var(--text-muted)}
        .running-total .amount{font-size:1.75rem;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums;transition:all 0.3s}
        /* Question Card */
        .q-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:2rem;display:none}
        .q-card.active{display:block;animation:slideIn 0.3s ease}
        @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
        .q-category{display:inline-block;background:var(--accent-light);color:var(--accent);padding:0.2rem 0.6rem;border-radius:0.25rem;font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem}
        .q-text{font-size:1.15rem;font-weight:600;margin-bottom:0.5rem;line-height:1.35}
        .q-hint{font-size:0.8rem;color:var(--text-muted);margin-bottom:1.25rem}
        .input-group{margin-bottom:1rem}
        .input-group label{display:block;font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.4rem;font-weight:500}
        .input-row{display:flex;align-items:stretch}
        .input-row input{flex:1;padding:0.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:0.5rem 0 0 0.5rem;color:var(--text-primary);font-size:1rem;border-right:none}
        .input-row input:focus{outline:none;border-color:var(--accent)}
        .input-row .unit{background:var(--bg-tertiary);border:1px solid var(--border);border-left:none;border-radius:0 0.5rem 0.5rem 0;padding:0 0.75rem;display:flex;align-items:center;color:var(--text-muted);font-size:0.8rem;min-width:60px;justify-content:center}
        select{width:100%;padding:0.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-size:1rem}
        select:focus{outline:none;border-color:var(--accent)}
        .nav-buttons{display:flex;gap:1rem;margin-top:1.5rem}
        .btn{flex:1;padding:0.875rem 1.25rem;border-radius:0.5rem;font-weight:600;font-size:0.95rem;cursor:pointer;transition:all 0.2s;border:none}
        .btn-primary{background:var(--accent);color:white}
        .btn-primary:hover{background:var(--accent-hover)}
        .btn-secondary{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border)}
        .btn-secondary:hover{background:var(--border);color:var(--text-primary)}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        /* Leak Reveal */
        .leak-reveal{background:var(--accent-light);border:1px solid rgba(239,68,68,0.3);border-radius:0.75rem;padding:1rem;margin-top:1rem;display:none}
        .leak-reveal.active{display:block;animation:fadeIn 0.3s ease}
        .leak-reveal .leak-amount{font-size:1.3rem;font-weight:700;color:var(--accent)}
        .leak-reveal .leak-desc{font-size:0.85rem;color:var(--text-secondary);margin-top:0.25rem}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* Results */
        .results-page{display:none}
        .results-page.active{display:block;animation:fadeIn 0.4s ease}
        .total-card{background:var(--bg-secondary);border:2px solid var(--accent);border-radius:1rem;padding:2.5rem;text-align:center;margin-bottom:2rem}
        .total-card .reveal-text{font-size:1rem;color:var(--text-secondary);margin-bottom:0.5rem}
        .total-card .total-amount{font-size:3.5rem;font-weight:700;color:var(--accent);line-height:1}
        .total-card .total-sub{font-size:1rem;color:var(--text-muted);margin-top:0.5rem}
        .total-card .total-context{color:var(--text-secondary);margin-top:1rem;font-size:0.95rem}
        .leaks-breakdown{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:2rem;margin-bottom:2rem}
        .leaks-breakdown h3{font-size:1.1rem;margin-bottom:1.25rem}
        .leak-row{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid var(--border)}
        .leak-row:last-child{border-bottom:none}
        .leak-row .name{font-size:0.9rem;color:var(--text-secondary)}
        .leak-row .val{font-size:1rem;font-weight:600;color:var(--accent)}
        .leak-bar-container{flex:1;height:8px;background:var(--bg-tertiary);border-radius:9999px;margin:0 1rem;overflow:hidden}
        .leak-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:9999px}
        /* Download Section */
        .download-section{background:linear-gradient(135deg,var(--accent-light),var(--bg-secondary));border:2px solid var(--accent);border-radius:1rem;padding:2.5rem;text-align:center;margin-bottom:2rem}
        .download-section h3{font-size:1.4rem;margin-bottom:0.5rem}
        .download-section>p{color:var(--text-secondary);margin-bottom:1.5rem}
        .download-features{display:flex;justify-content:center;gap:1.5rem;margin-bottom:1.5rem;flex-wrap:wrap}
        .download-feature{display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;color:var(--text-secondary)}
        .download-feature .icon{color:var(--success)}
        .email-form{display:flex;gap:0.75rem;max-width:450px;margin:0 auto;flex-wrap:wrap}
        .email-form input[type="email"]{flex:1;min-width:200px;padding:0.875rem 1rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-size:1rem}
        .email-form input:focus{outline:none;border-color:var(--accent)}
        .email-form .btn{flex:none;min-width:180px}
        .download-complete{display:none;color:var(--success);padding:1rem;font-size:1rem}
        .download-complete.active{display:block}
        footer{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.875rem}
        footer a{color:var(--accent);text-decoration:none}
        @media(max-width:640px){.container{padding:1rem}h1{font-size:1.65rem}.total-card .total-amount{font-size:2.5rem}.running-total .amount{font-size:1.3rem}}
    </style>
</head>
<body>
<div class="container">
    <header>
        <span class="badge">Free Diagnostic</span>
        <h1>The $100K You Don't Know You're Losing</h1>
        <p class="subtitle">Answer 8 questions about your operations. We'll calculate exactly how much profit is silently leaking from your distribution business.</p>
    </header>
    <div class="progress-container" id="progressContainer">
        <div class="progress-header">
            <span class="progress-label">Diagnostic Progress</span>
            <span class="progress-count"><span id="currentQ">1</span> of <span id="totalQ">8</span></span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:12.5%"></div></div>
    </div>
    <div class="running-total" id="runningTotal">
        <span class="label">üí∏ Estimated Annual Profit Leakage</span>
        <span class="amount" id="runningAmount">$0</span>
    </div>
    <div id="questionsContainer"></div>
    <div class="results-page" id="resultsPage">
        <div class="total-card">
            <div class="reveal-text">Your distribution business is silently losing an estimated</div>
            <div class="total-amount" id="finalTotal">$0</div>
            <div class="total-sub">per year</div>
            <div class="total-context" id="totalContext"></div>
        </div>
        <div class="leaks-breakdown">
            <h3>Where It's Going</h3>
            <div id="leaksBreakdown"></div>
        </div>
        <div class="download-section" id="downloadSection">
            <h3>üìÑ Get Your Full Profit Recovery Plan</h3>
            <p>Download a detailed PDF showing exactly how to plug each leak, with implementation timelines and projected ROI.</p>
            <div class="download-features">
                <div class="download-feature"><span class="icon">‚úì</span><span>Fix-by-fix action plan</span></div>
                <div class="download-feature"><span class="icon">‚úì</span><span>ROI per improvement</span></div>
                <div class="download-feature"><span class="icon">‚úì</span><span>Priority ranking</span></div>
            </div>
            <form class="email-form" id="emailForm" onsubmit="handleDownload(event)">
                <input type="email" id="userEmail" placeholder="Enter your work email" required>
                <button type="submit" class="btn btn-primary">üì• Download PDF</button>
            </form>
            <div class="download-complete" id="downloadComplete">‚úì Report downloaded! Check your downloads folder.</div>
        </div>
    </div>
    <footer><p>Built by <a href="#">Mo Roowala</a> | AI Automation for Distributors</p></footer>
</div>
<script>
const { jsPDF } = window.jspdf;

const steps = [
    {
        category: "Revenue",
        question: "What is your approximate annual revenue?",
        hint: "This helps us calculate dollar amounts specific to your business.",
        inputs: [
            { id: "revenue", label: "Annual Revenue", type: "number", placeholder: "e.g., 25000000", unit: "$" }
        ],
        calc: (vals) => ({ leak: 0, label: "Baseline", desc: "" })
    },
    {
        category: "Pricing",
        question: "How do your sales reps handle pricing?",
        hint: "Inconsistent pricing is the #1 profit leak in distribution. A 1% price reduction can wipe out 11% of profit.",
        inputs: [
            { id: "pricingMethod", label: "Primary pricing method", type: "select", options: [
                { value: "gut", text: "Reps decide based on gut/experience" },
                { value: "lists", text: "Price lists exist but lots of exceptions" },
                { value: "system", text: "System-driven with clear rules" }
            ]},
            { id: "overridesPerWeek", label: "Price overrides or exceptions per week", type: "number", placeholder: "e.g., 15", unit: "/week" }
        ],
        calc: (vals) => {
            const rev = parseFloat(vals.revenue) || 0;
            const method = vals.pricingMethod;
            const overrides = parseFloat(vals.overridesPerWeek) || 0;
            let leakPct = method === 'gut' ? 0.01 : method === 'lists' ? 0.006 : 0.002;
            leakPct += (overrides * 0.0003);
            const leak = Math.round(rev * leakPct);
            return { leak, label: "Pricing Inconsistency", desc: `${overrides} overrides/week at ~${(leakPct*100).toFixed(2)}% revenue impact` };
        }
    },
    {
        category: "Order Processing",
        question: "How many orders does your team process per day, and how?",
        hint: "Manual order entry costs $5-15 per order in labor. Errors cost 10-20x more to fix.",
        inputs: [
            { id: "ordersPerDay", label: "Orders processed per day", type: "number", placeholder: "e.g., 50", unit: "/day" },
            { id: "manualPct", label: "% entered manually (from email/phone)", type: "number", placeholder: "e.g., 70", unit: "%" },
            { id: "errorRate", label: "Estimated error rate", type: "number", placeholder: "e.g., 3", unit: "%" }
        ],
        calc: (vals) => {
            const orders = parseFloat(vals.ordersPerDay) || 0;
            const manual = (parseFloat(vals.manualPct) || 0) / 100;
            const errorRate = (parseFloat(vals.errorRate) || 0) / 100;
            const manualCostPerOrder = 5;
            const errorCostPerOrder = 85;
            const yearlyOrders = orders * 260;
            const manualCost = Math.round(yearlyOrders * manual * manualCostPerOrder);
            const errorCost = Math.round(yearlyOrders * errorRate * errorCostPerOrder);
            const leak = manualCost + errorCost;
            return { leak, label: "Order Processing Waste", desc: `${Math.round(yearlyOrders*manual).toLocaleString()} manual entries + ${Math.round(yearlyOrders*errorRate).toLocaleString()} errors/year` };
        }
    },
    {
        category: "Quoting",
        question: "How long does it take to turn around a quote?",
        hint: "Every hour of delay on a quote reduces win rate by 2-5%. Speed to quote is speed to revenue.",
        inputs: [
            { id: "quotesPerWeek", label: "Quotes sent per week", type: "number", placeholder: "e.g., 30", unit: "/week" },
            { id: "quoteHours", label: "Average hours to send a quote", type: "number", placeholder: "e.g., 4", unit: "hours" },
            { id: "avgQuoteValue", label: "Average quote value", type: "number", placeholder: "e.g., 5000", unit: "$" }
        ],
        calc: (vals) => {
            const quotes = parseFloat(vals.quotesPerWeek) || 0;
            const hours = parseFloat(vals.quoteHours) || 0;
            const value = parseFloat(vals.avgQuoteValue) || 0;
            const lostPct = Math.min(hours * 0.02, 0.15);
            const yearlyQuotes = quotes * 52;
            const leak = Math.round(yearlyQuotes * value * lostPct * 0.15);
            return { leak, label: "Slow Quote Response", desc: `${hours}hr avg turnaround losing ~${(lostPct*100).toFixed(0)}% of winnable deals` };
        }
    },
    {
        category: "Inventory",
        question: "How accurate is your inventory, and how often do you have stockouts?",
        hint: "The average distributor has 20-30% excess inventory and 5-10% stockout rate.",
        inputs: [
            { id: "inventoryValue", label: "Total inventory value", type: "number", placeholder: "e.g., 3000000", unit: "$" },
            { id: "stockoutPct", label: "Estimated stockout rate (% of orders)", type: "number", placeholder: "e.g., 5", unit: "%" },
            { id: "excessPct", label: "Estimated excess/dead stock (%)", type: "number", placeholder: "e.g., 15", unit: "%" }
        ],
        calc: (vals) => {
            const rev = parseFloat(vals.revenue) || 0;
            const inv = parseFloat(vals.inventoryValue) || 0;
            const stockout = (parseFloat(vals.stockoutPct) || 0) / 100;
            const excess = (parseFloat(vals.excessPct) || 0) / 100;
            const stockoutLoss = Math.round(rev * stockout * 0.15);
            const carryingCost = Math.round(inv * excess * 0.25);
            const leak = stockoutLoss + carryingCost;
            return { leak, label: "Inventory Mismanagement", desc: `$${stockoutLoss.toLocaleString()} lost sales + $${carryingCost.toLocaleString()} carrying cost` };
        }
    },
    {
        category: "Customer Retention",
        question: "What does customer churn look like for you?",
        hint: "Acquiring a new customer costs 5-7x more than retaining one. Most distributors don't track churn.",
        inputs: [
            { id: "totalCustomers", label: "Active customers", type: "number", placeholder: "e.g., 200", unit: "" },
            { id: "churnPct", label: "% of customers lost per year", type: "number", placeholder: "e.g., 10", unit: "%" },
            { id: "avgCustomerValue", label: "Average annual customer value", type: "number", placeholder: "e.g., 50000", unit: "$" }
        ],
        calc: (vals) => {
            const customers = parseFloat(vals.totalCustomers) || 0;
            const churn = (parseFloat(vals.churnPct) || 0) / 100;
            const acv = parseFloat(vals.avgCustomerValue) || 0;
            const preventable = 0.2;
            const leak = Math.round(customers * churn * acv * preventable);
            return { leak, label: "Preventable Customer Churn", desc: `${Math.round(customers*churn)} customers lost/year, ~30% preventable with automation` };
        }
    },
    {
        category: "Labor",
        question: "How much time does your team spend on tasks that should be automated?",
        hint: "The average distributor employee spends 40% of their time on repetitive manual tasks.",
        inputs: [
            { id: "employeeCount", label: "Number of office/admin employees", type: "number", placeholder: "e.g., 12", unit: "" },
            { id: "avgSalary", label: "Average annual salary", type: "number", placeholder: "e.g., 55000", unit: "$" },
            { id: "manualTimePct", label: "% of time on repetitive manual work", type: "number", placeholder: "e.g., 35", unit: "%" }
        ],
        calc: (vals) => {
            const count = parseFloat(vals.employeeCount) || 0;
            const salary = parseFloat(vals.avgSalary) || 0;
            const manual = (parseFloat(vals.manualTimePct) || 0) / 100;
            const automatable = 0.4;
            const leak = Math.round(count * salary * manual * automatable);
            return { leak, label: "Wasted Labor Hours", desc: `${count} employees x ${(manual*100).toFixed(0)}% manual time x 60% automatable` };
        }
    },
    {
        category: "Supplier",
        question: "How do you handle supplier price changes?",
        hint: "Most distributors take 2-4 weeks to pass through supplier increases. Every day of delay erodes margin.",
        inputs: [
            { id: "priceChangesYear", label: "Supplier price changes per year", type: "number", placeholder: "e.g., 50", unit: "/year" },
            { id: "daysToUpdate", label: "Average days to update your prices", type: "number", placeholder: "e.g., 14", unit: "days" },
            { id: "avgChangeImpact", label: "Avg revenue affected per change", type: "number", placeholder: "e.g., 100000", unit: "$" }
        ],
        calc: (vals) => {
            const changes = parseFloat(vals.priceChangesYear) || 0;
            const days = parseFloat(vals.daysToUpdate) || 0;
            const impact = parseFloat(vals.avgChangeImpact) || 0;
            const dailyMarginLoss = 0.0003;
            const leak = Math.round(changes * days * impact * dailyMarginLoss);
            return { leak, label: "Slow Price Pass-Through", desc: `${days} day avg delay across ${changes} changes/year` };
        }
    }
];

let currentStep = 0;
let allValues = {};
let leaks = [];
let runningLeak = 0;

function init() {
    document.getElementById('totalQ').textContent = steps.length;
    renderStep(0);
}

function renderStep(idx) {
    const s = steps[idx];
    const container = document.getElementById('questionsContainer');
    let html = `<div class="q-card active">
        <span class="q-category">${s.category}</span>
        <h2 class="q-text">${s.question}</h2>
        <p class="q-hint">${s.hint}</p>`;

    s.inputs.forEach(inp => {
        html += `<div class="input-group"><label for="${inp.id}">${inp.label}</label>`;
        if (inp.type === 'select') {
            html += `<select id="${inp.id}">`;
            inp.options.forEach(o => {
                const sel = allValues[inp.id] === o.value ? 'selected' : '';
                html += `<option value="${o.value}" ${sel}>${o.text}</option>`;
            });
            html += `</select>`;
        } else {
            const val = allValues[inp.id] || '';
            if (inp.unit && inp.unit !== '') {
                html += `<div class="input-row"><input type="number" id="${inp.id}" placeholder="${inp.placeholder}" value="${val}" min="0" step="any">
                    <span class="unit">${inp.unit}</span></div>`;
            } else {
                html += `<div class="input-row"><input type="number" id="${inp.id}" placeholder="${inp.placeholder}" value="${val}" min="0" step="any">
                    <span class="unit">#</span></div>`;
            }
        }
        html += `</div>`;
    });

    html += `<div class="leak-reveal" id="leakReveal"></div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="prevStep()" ${idx===0?'disabled':''}>‚Üê Back</button>
            <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">${idx===steps.length-1?'See Full Results':'Next ‚Üí'}</button>
        </div></div>`;

    container.innerHTML = html;
    document.getElementById('currentQ').textContent = idx + 1;
    document.getElementById('progressFill').style.width = ((idx+1)/steps.length*100) + '%';
}

function saveCurrentInputs() {
    const s = steps[currentStep];
    s.inputs.forEach(inp => {
        const el = document.getElementById(inp.id);
        if (el) allValues[inp.id] = el.value;
    });
}

function nextStep() {
    saveCurrentInputs();

    // Calculate leak for current step
    if (currentStep > 0 || steps[currentStep].calc) {
        const result = steps[currentStep].calc(allValues);
        if (result.leak > 0) {
            leaks[currentStep] = result;
            recalcTotal();
        }
    }

    if (currentStep < steps.length - 1) {
        currentStep++;
        renderStep(currentStep);
    } else {
        showResults();
    }
}

function prevStep() {
    saveCurrentInputs();
    if (currentStep > 0) {
        currentStep--;
        renderStep(currentStep);
    }
}

function recalcTotal() {
    runningLeak = leaks.reduce((sum, l) => sum + (l ? l.leak : 0), 0);
    const el = document.getElementById('runningAmount');
    el.textContent = '$' + runningLeak.toLocaleString();
    el.style.transform = 'scale(1.1)';
    setTimeout(() => el.style.transform = 'scale(1)', 200);
}

function showResults() {
    document.getElementById('questionsContainer').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'none';
    document.getElementById('runningTotal').style.display = 'none';
    document.getElementById('resultsPage').classList.add('active');

    const total = runningLeak;
    document.getElementById('finalTotal').textContent = '$' + total.toLocaleString();

    const rev = parseFloat(allValues.revenue) || 1;
    const pctOfRev = ((total / rev) * 100).toFixed(1);
    const perMonth = Math.round(total / 12).toLocaleString();
    const perDay = Math.round(total / 365).toLocaleString();
    document.getElementById('totalContext').innerHTML =
        `That's <strong>${pctOfRev}% of your revenue</strong>. $${perMonth} per month. $${perDay} every single day. Most of it is recoverable.`;

    // Breakdown
    const validLeaks = leaks.filter(l => l && l.leak > 0).sort((a, b) => b.leak - a.leak);
    const maxLeak = validLeaks[0]?.leak || 1;
    document.getElementById('leaksBreakdown').innerHTML = validLeaks.map(l => `
        <div class="leak-row">
            <span class="name" style="min-width:140px">${l.label}</span>
            <div class="leak-bar-container"><div class="leak-bar" style="width:${(l.leak/maxLeak*100)}%"></div></div>
            <span class="val">$${l.leak.toLocaleString()}</span>
        </div>
    `).join('');
}

function handleDownload(e) {
    e.preventDefault();
    const email = document.getElementById('userEmail').value;
    const leads = JSON.parse(localStorage.getItem('profitleak_leads') || '[]');
    leads.push({ email, timestamp: new Date().toISOString(), total: runningLeak, leaks, inputs: allValues });
    localStorage.setItem('profitleak_leads', JSON.stringify(leads));
    generatePDF(email);
    document.getElementById('emailForm').style.display = 'none';
    document.getElementById('downloadComplete').classList.add('active');
}

function generatePDF(email) {
    const doc = new jsPDF();
    const pw = doc.internal.pageSize.getWidth();
    const ph = doc.internal.pageSize.getHeight();
    const m = 16, cw = pw - 2*m;
    let y = 0;

    const C = {
        bg: [218,215,210], card: [240,238,235], cardAlt: [232,230,226],
        dark: [32,34,44], darkSoft: [48,50,58],
        text: [45,45,50], textMid: [75,75,80], textLight: [100,100,105], textMuted: [130,130,135],
        white: [255,255,255], shadow: [195,192,188],
        red: [200,58,48], redLight: [230,90,75], redBg: [235,222,220],
        green: [35,160,88], amber: [210,145,30], blue: [50,115,210], purple: [125,80,200]
    };

    const txt = (t,sz,st='normal',c=C.text) => { doc.setFontSize(sz); doc.setFont('helvetica',st); doc.setTextColor(...c); };
    const fill = (c) => doc.setFillColor(...c);
    const newPage = () => {
        doc.addPage();
        fill(C.bg); doc.rect(0,0,pw,ph,'F');
        fill(C.red); doc.rect(0,0,pw,1.2,'F');
        fill([225,222,218]); doc.rect(0,0,6,ph,'F');
        fill(C.red); doc.rect(5,20,1,30,'F');
        y = 16;
    };
    const cp = (n=25) => { if(y+n>262){newPage(); return true;} return false; };
    const card = (x,yc,w,h,opts={}) => {
        fill(C.shadow); doc.roundedRect(x+1,yc+1,w,h,2.5,2.5,'F');
        fill(opts.bg||C.card); doc.roundedRect(x,yc,w,h,2.5,2.5,'F');
        if(opts.accent){fill(opts.accent);doc.roundedRect(x,yc,3.5,h,2.5,0,'F');doc.rect(x+1.5,yc,2,h,'F');}
    };
    const secTitle = (title,yy,color=C.red) => {
        fill(color); doc.roundedRect(m,yy,3,10,1,1,'F');
        txt(title,11,'bold',C.text); doc.text(title,m+8,yy+7);
        doc.setDrawColor(...C.shadow); doc.setLineWidth(0.3); doc.line(m+8,yy+10,pw-m,yy+10);
        return yy+14;
    };

    // ================================================================
    // PAGE 1: COVER
    // ================================================================
    fill(C.bg); doc.rect(0,0,pw,ph,'F');
    fill(C.dark); doc.rect(0,0,pw,78,'F');
    fill(C.red); doc.rect(0,76.5,pw,1.5,'F');

    fill(C.red); doc.circle(pw/2,18,7,'F');
    txt('A',10,'bold',C.dark); doc.text('A',pw/2,21,{align:'center'});
    txt('PROFIT LEAK DIAGNOSTIC',20,'bold',C.white); doc.text('PROFIT LEAK DIAGNOSTIC',pw/2,40,{align:'center'});
    txt('Your Personalized Recovery Plan',9,'normal',[170,170,185]); doc.text('Your Personalized Recovery Plan',pw/2,49,{align:'center'});
    fill(C.darkSoft); doc.roundedRect(pw/2-45,56,90,9,4,4,'F');
    txt(new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}),7,'normal',[155,155,170]);
    doc.text(new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}),pw/2,62,{align:'center'});

    y = 88;

    // Big number
    card(m,y,cw,36,{accent:C.red});
    txt('YOUR ESTIMATED ANNUAL PROFIT LEAKAGE',7,'bold',C.red); doc.text('YOUR ESTIMATED ANNUAL PROFIT LEAKAGE',m+cw/2,y+8,{align:'center'});
    txt('$' + runningLeak.toLocaleString(),26,'bold',C.red); doc.text('$' + runningLeak.toLocaleString(),m+cw/2,y+22,{align:'center'});
    const rev = parseFloat(allValues.revenue) || 1;
    txt(`${((runningLeak/rev)*100).toFixed(1)}% of your annual revenue`,8,'normal',C.textMid);
    doc.text(`${((runningLeak/rev)*100).toFixed(1)}% of your annual revenue`,m+cw/2,y+30,{align:'center'});
    y += 48;

    // 3-column metrics
    const metW = (cw-8)/3;
    const perMonth = Math.round(runningLeak/12);
    const perDay = Math.round(runningLeak/365);
    const mets = [
        {val:'$'+perMonth.toLocaleString(),label:'PER MONTH',color:C.red},
        {val:'$'+perDay.toLocaleString(),label:'PER DAY',color:C.amber},
        {val:((runningLeak/rev)*100).toFixed(1)+'%',label:'OF REVENUE',color:C.purple}
    ];
    mets.forEach((mt,i) => {
        const x = m+i*(metW+4);
        card(x,y,metW,28,{accent:mt.color});
        txt(mt.val,14,'bold',mt.color); doc.text(mt.val,x+metW/2+2,y+13,{align:'center'});
        txt(mt.label,6.5,'bold',C.textMid); doc.text(mt.label,x+metW/2+2,y+21,{align:'center'});
    });
    y += 36;

    // Leak breakdown chart
    y = secTitle('WHERE YOUR PROFIT IS LEAKING', y);
    const validLeaks = leaks.filter(l=>l&&l.leak>0).sort((a,b)=>b.leak-a.leak);
    const maxLeak = validLeaks[0]?.leak || 1;

    // Use ranked colors: #1 darkest red, fading to amber/orange for lower items
    const leakColors = [[180,40,35],[195,55,45],[210,80,50],[220,110,45],[215,140,35],[200,155,40],[185,160,50]];

    card(m,y,cw,validLeaks.length*16+14);
    let bY = y+10;
    validLeaks.forEach((l,li) => {
        const barCol = leakColors[Math.min(li, leakColors.length-1)];

        // Rank number instead of dot
        fill(C.dark); doc.roundedRect(m+6,bY-2,10,8,2,2,'F');
        txt((li+1).toString(),7,'bold',C.white); doc.text((li+1).toString(),m+11,bY+3.5,{align:'center'});

        // Label
        txt(l.label,8,'bold',C.text); doc.text(l.label,m+20,bY+3);

        // Dollar amount right-aligned
        txt('$'+l.leak.toLocaleString(),8,'bold',barCol); doc.text('$'+l.leak.toLocaleString(),pw-m-8,bY+3,{align:'right'});

        // Horizontal bar below label
        const barX=m+20, barW=cw-54;
        const w = Math.max((l.leak/maxLeak)*barW,3);
        fill(C.cardAlt); doc.roundedRect(barX,bY+6,barW,4,1.5,1.5,'F');
        fill(barCol); doc.roundedRect(barX,bY+6,w,4,1.5,1.5,'F');

        // Percentage label on bar
        const pct = Math.round((l.leak/runningLeak)*100);
        if(w > 15) { txt(pct+'%',5.5,'bold',C.white); doc.text(pct+'%',barX+w-2,bY+9,{align:'right'}); }

        bY += 16;
    });
    y = bY+6;

    // ================================================================
    // DETAILED RECOVERY PLANS
    // ================================================================
    newPage();
    fill(C.dark); doc.roundedRect(m,y,cw,16,3,3,'F');
    fill(C.red); doc.rect(m,y+14,cw,2,'F');
    txt('DETAILED RECOVERY PLAN',12,'bold',C.white); doc.text('DETAILED RECOVERY PLAN',pw/2,y+10,{align:'center'});
    y += 24;

    const fixes = {
        "Pricing Inconsistency": {
            priority:"CRITICAL", impact:"Recovers 1-3% of revenue",
            quickWin:"Audit top 50 SKUs. Set floor prices. One distributor recovered $101,700 on $32M revenue.",
            steps:["Week 1-2: Pull every quote from last 90 days. Compare margins across same SKUs and customer tiers.",
                "Week 3-4: Create pricing matrix by customer tier (A/B/C) and product category with floor prices.",
                "Week 5-6: Implement approval workflow. Below-floor quotes require manager sign-off with documented reason.",
                "Week 7-8: Configure ERP pricing module. Automate the matrix rules.",
                "Month 3: Review pricing compliance weekly. Track override frequency and margin impact."]
        },
        "Order Processing Waste": {
            priority:"HIGH", impact:"Reduces labor 30-50%, errors 70%+",
            quickWin:"Add order validation screen with summary. Catches 40% of entry errors immediately.",
            steps:["Week 1-2: Time-study your order entry. Document every step from email to system.",
                "Week 3-4: Categorize orders by complexity. 60-80% follow standard patterns.",
                "Week 5-6: Set up email parsing or automation for standard orders.",
                "Week 7-8: Create customer self-service portal for top 20 accounts.",
                "Month 3: Measure error rate weekly. Target 70% reduction in corrections."]
        },
        "Slow Quote Response": {
            priority:"HIGH", impact:"Increases quote-to-close 15-25%",
            quickWin:"Create templates for top 10 quote types with pre-populated pricing.",
            steps:["Week 1-2: Measure current turnaround from request received to quote sent.",
                "Week 3-4: Build quoting tool or configure ERP quote module with auto-pricing.",
                "Week 5-6: Set targets: same-day for standard, 24hr for complex.",
                "Week 7-8: Add automated 3-day follow-up on open quotes.",
                "Month 3: Track win rate by response time. Correlation is immediate."]
        },
        "Inventory Mismanagement": {
            priority:"HIGH", impact:"Reduces carrying costs 20-30%, stockouts 50%+",
            quickWin:"Run ABC analysis today. Set reorder alerts for A items.",
            steps:["Week 1-2: Classify inventory: A=top 80% revenue, B=next 15%, C=bottom 5%.",
                "Week 3-4: Calculate reorder points for A items. Set up ERP auto-alerts.",
                "Week 5-6: Identify and liquidate dead stock (no movement 12+ months).",
                "Week 7-8: Implement cycle counting: A monthly, B quarterly, C annually.",
                "Month 3: Track fill rate weekly. Target 95%+."]
        },
        "Preventable Customer Churn": {
            priority:"MEDIUM", impact:"5% more retention = 25-95% more profit",
            quickWin:"Call top 10 churned customers. Ask what happened. Document everything.",
            steps:["Week 1-2: Pull customers who ordered last year but not this year (silent churn list).",
                "Week 3-4: Identify top 3 churn reasons: price, service, stockouts, competition.",
                "Week 5-6: Set automated 'at risk' alerts when A/B customer frequency drops 30%.",
                "Week 7-8: Create customer health dashboard: frequency, order value, complaints.",
                "Month 3: Quarterly business reviews with top 20 accounts."]
        },
        "Wasted Labor Hours": {
            priority:"MEDIUM", impact:"Frees 20-40% of admin time",
            quickWin:"Survey your team: 'What tasks feel like a waste of time?' You'll get gold.",
            steps:["Week 1-2: Rank tasks by frequency and time consumed. Top 5 are automation targets.",
                "Week 3-4: Implement quick wins: email templates, auto-reports, standard forms.",
                "Week 5-6: Evaluate RPA for high-volume repetitive tasks like data entry.",
                "Week 7-8: Redeploy freed time to customer-facing activities.",
                "Month 3: Measure hours saved per employee per week."]
        },
        "Slow Price Pass-Through": {
            priority:"MEDIUM", impact:"Protects margin during supplier increase cycles",
            quickWin:"List all supplier changes in 12 months. Note lag between their change and yours.",
            steps:["Week 1-2: Create price change playbook: who does what, in what order.",
                "Week 3-4: Set up supplier price monitoring (shared spreadsheet with alerts).",
                "Week 5-6: Pre-calculate customer adjustments with auto-pricing formulas.",
                "Week 7-8: Implement automated customer price change notifications.",
                "Month 3: Target same-week pass-through. Track days-to-update as KPI."]
        }
    };

    let fixIdx = 0;
    validLeaks.forEach(leak => {
        const fix = fixes[leak.label];
        if(!fix) return;
        fixIdx++;
        cp(80);

        const pColors = {CRITICAL:C.red, HIGH:C.amber, MEDIUM:C.blue};
        const col = pColors[fix.priority]||C.textLight;

        // Header bar with number
        fill(col); doc.roundedRect(m,y,cw,10,2,2,'F');
        fill(C.dark); doc.circle(m+8,y+5,4.5,'F');
        txt(fixIdx.toString(),8,'bold',C.white); doc.text(fixIdx.toString(),m+8,y+7.5,{align:'center'});
        txt(leak.label.toUpperCase(),9,'bold',C.white); doc.text(leak.label.toUpperCase(),m+17,y+7);
        txt('$'+leak.leak.toLocaleString()+'/yr',8,'bold',C.white); doc.text('$'+leak.leak.toLocaleString()+'/yr',pw-m-5,y+7,{align:'right'});
        y += 14;

        // Priority + Impact
        card(m,y,cw,14);
        txt(`Priority: ${fix.priority}`,7,'bold',col); doc.text(`Priority: ${fix.priority}`,m+8,y+6);
        txt(`Expected Impact: ${fix.impact}`,7,'normal',C.textMid); doc.text(`Expected Impact: ${fix.impact}`,m+50,y+6);
        y += 18;

        // Quick Win
        card(m,y,cw,12,{bg:[235,222,220],accent:C.red});
        txt('QUICK WIN',6,'bold',C.red); doc.text('QUICK WIN',m+8,y+5);
        txt(fix.quickWin,7,'normal',C.text);
        const qwL = doc.splitTextToSize(fix.quickWin,cw-16);
        doc.text(qwL,m+8,y+9.5);
        y += Math.max(12, qwL.length*3.5+10);

        // Steps
        txt('ACTION STEPS',6.5,'bold',C.textMid); doc.text('ACTION STEPS',m+2,y+3); y+=7;
        fix.steps.forEach((step,si) => {
            cp(12);
            fill(col); doc.circle(m+5,y+1,2.5,'F');
            txt((si+1).toString(),6,'bold',C.white); doc.text((si+1).toString(),m+5,y+2.8,{align:'center'});
            txt(step,7,'normal',C.text);
            const sL = doc.splitTextToSize(step,cw-16);
            doc.text(sL,m+12,y+2);
            y += sL.length*3.5+2.5;
        });
        y += 8;
    });

    // ================================================================
    // 90-DAY ROADMAP
    // ================================================================
    newPage();
    fill(C.dark); doc.roundedRect(m,y,cw,16,3,3,'F');
    fill(C.red); doc.rect(m,y+14,cw,2,'F');
    txt('90-DAY PROFIT RECOVERY ROADMAP',12,'bold',C.white); doc.text('90-DAY PROFIT RECOVERY ROADMAP',pw/2,y+10,{align:'center'});
    y += 24;

    const phases = [
        {title:'DAYS 1-14: QUICK WINS',color:C.green,items:[
            'Audit pricing on top 50 SKUs. Set floor prices immediately.',
            'Call top 10 churned customers. Document why they left.',
            'Survey employees on biggest time-wasters.',
            'Measure current quote turnaround and order error rate.'
        ]},
        {title:'DAYS 15-30: FOUNDATIONS',color:C.amber,items:[
            'Build pricing matrix by customer tier and volume.',
            'Create quote templates for top 10 quote types.',
            'Run ABC analysis. Set reorder points for A items.',
            'Implement approval workflow for below-floor pricing.'
        ]},
        {title:'DAYS 31-60: AUTOMATION',color:C.blue,items:[
            'Configure ERP pricing module with matrix and rules.',
            'Set up order validation and automated alerts.',
            'Deploy reorder point notifications.',
            'Build customer health monitoring dashboard.'
        ]},
        {title:'DAYS 61-90: OPTIMIZATION',color:C.purple,items:[
            'Review all KPIs: error rate, quote speed, margin, fill rate.',
            'Fine-tune automation rules based on real results.',
            'Expand automation to B-tier items and processes.',
            'Calculate actual recovered profit. Celebrate with team.'
        ]}
    ];

    phases.forEach((phase,pi) => {
        cp(45);
        const dotX = m+6;
        fill(phase.color); doc.circle(dotX,y+5,3.5,'F');
        txt((pi+1).toString(),7,'bold',C.white); doc.text((pi+1).toString(),dotX,y+7,{align:'center'});
        if(pi<phases.length-1){doc.setDrawColor(...C.shadow);doc.setLineWidth(0.8);doc.line(dotX,y+9,dotX,y+40);}

        fill(phase.color); doc.roundedRect(m+16,y,cw-16,8,2,2,'F');
        txt(phase.title,8,'bold',C.white); doc.text(phase.title,m+22,y+6);
        y+=12;

        phase.items.forEach(item => {
            fill(phase.color); doc.circle(m+20,y+1.5,1.2,'F');
            txt(item,7.5,'normal',C.text);
            const iL = doc.splitTextToSize(item,cw-30);
            doc.text(iL,m+25,y+2.5);
            y += iL.length*3.8+2;
        });
        y+=8;
    });

    // Recovery projection
    y = secTitle('PROJECTED RECOVERY', y, C.green);
    const conservative = Math.round(runningLeak*0.3);
    const moderate = Math.round(runningLeak*0.5);
    const aggressive = Math.round(runningLeak*0.7);

    const projW = (cw-8)/3;
    [{val:conservative,label:'CONSERVATIVE (30%)',color:C.blue},{val:moderate,label:'MODERATE (50%)',color:C.green},{val:aggressive,label:'AGGRESSIVE (70%)',color:C.amber}].forEach((p,i) => {
        const x = m+i*(projW+4);
        card(x,y,projW,28,{accent:p.color});
        txt('$'+p.val.toLocaleString(),13,'bold',p.color); doc.text('$'+p.val.toLocaleString(),x+projW/2+2,y+13,{align:'center'});
        txt(p.label,5.5,'bold',C.textMid); doc.text(p.label,x+projW/2+2,y+21,{align:'center'});
    });
    y += 36;

    txt('Most distributors achieve moderate recovery within 6-12 months of starting.',7,'normal',C.textLight);
    doc.text('Most distributors achieve moderate recovery within 6-12 months of starting.',pw/2,y,{align:'center'});
    y += 12;

    // CTA
    cp(40);
    fill(C.dark); doc.roundedRect(m,y,cw,36,3,3,'F');
    fill(C.red); doc.rect(m,y+34,cw,2,'F');
    txt("LET'S RECOVER YOUR PROFIT",13,'bold',C.white); doc.text("LET'S RECOVER YOUR PROFIT",pw/2,y+12,{align:'center'});
    txt("You know where the money is going. Let's build a plan to get it back.",8,'normal',[210,210,220]);
    doc.text("You know where the money is going. Let's build a plan to get it back.",pw/2,y+20,{align:'center'});
    txt('mo@deeplineop.ai',12,'bold',C.white); doc.text('mo@deeplineop.ai',pw/2,y+30,{align:'center'});

    // Footer
    const pc = doc.internal.getNumberOfPages();
    for(let i=1;i<=pc;i++){
        doc.setPage(i);
        fill(C.dark); doc.rect(0,ph-8,pw,8,'F');
        fill(C.red); doc.rect(0,ph-8,pw,0.5,'F');
        txt('Mo Roowala  |  Deep Line Operations  |  AI Automation for Distributors',6,'normal',[140,140,155]);
        doc.text('Mo Roowala  |  Deep Line Operations  |  AI Automation for Distributors',pw/2,ph-3,{align:'center'});
        txt(`Page ${i} of ${pc}`,5.5,'normal',[120,120,135]); doc.text(`Page ${i} of ${pc}`,pw-m,ph-3,{align:'right'});
    }
    doc.save('Profit-Leak-Diagnostic-Report.pdf');
}


init();
</script>
</body>
</html>
