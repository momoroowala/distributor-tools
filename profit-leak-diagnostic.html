<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Leak Diagnostic | Free Tool for Distributors</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-tertiary:#1a1a25;--accent:#ef4444;--accent-hover:#f87171;--accent-light:rgba(239,68,68,0.1);--accent2:#f59e0b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--border:#2a2a3a;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.6}
        .container{max-width:700px;margin:0 auto;padding:2rem}
        header{text-align:center;margin-bottom:2rem;padding-top:2rem}
        .badge{display:inline-block;background:var(--accent);color:white;padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem}
        h1{font-size:2.1rem;font-weight:700;margin-bottom:0.75rem;background:linear-gradient(135deg,var(--text-primary) 0%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .subtitle{color:var(--text-secondary);font-size:1.05rem;max-width:520px;margin:0 auto}
        .progress-container{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:1.25rem 1.5rem;margin-bottom:1.5rem}
        .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
        .progress-label{font-size:0.8rem;color:var(--text-muted)}
        .progress-count{font-size:0.8rem;color:var(--accent);font-weight:600}
        .progress-bar{height:6px;background:var(--bg-tertiary);border-radius:9999px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:9999px;transition:width 0.3s}
        /* Running Total */
        .running-total{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:1.25rem 1.5rem;margin-bottom:1.5rem;display:flex;align-items:center;justify-content:space-between}
        .running-total .label{font-size:0.85rem;color:var(--text-muted)}
        .running-total .amount{font-size:1.75rem;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums;transition:all 0.3s}
        /* Question Card */
        .q-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:2rem;display:none}
        .q-card.active{display:block;animation:slideIn 0.3s ease}
        @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
        .q-category{display:inline-block;background:var(--accent-light);color:var(--accent);padding:0.2rem 0.6rem;border-radius:0.25rem;font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem}
        .q-text{font-size:1.15rem;font-weight:600;margin-bottom:0.5rem;line-height:1.35}
        .q-hint{font-size:0.8rem;color:var(--text-muted);margin-bottom:1.25rem}
        .input-group{margin-bottom:1rem}
        .input-group label{display:block;font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.4rem;font-weight:500}
        .input-row{display:flex;align-items:stretch}
        .input-row input{flex:1;padding:0.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:0.5rem 0 0 0.5rem;color:var(--text-primary);font-size:1rem;border-right:none}
        .input-row input:focus{outline:none;border-color:var(--accent)}
        .input-row .unit{background:var(--bg-tertiary);border:1px solid var(--border);border-left:none;border-radius:0 0.5rem 0.5rem 0;padding:0 0.75rem;display:flex;align-items:center;color:var(--text-muted);font-size:0.8rem;min-width:60px;justify-content:center}
        select{width:100%;padding:0.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-size:1rem}
        select:focus{outline:none;border-color:var(--accent)}
        .nav-buttons{display:flex;gap:1rem;margin-top:1.5rem}
        .btn{flex:1;padding:0.875rem 1.25rem;border-radius:0.5rem;font-weight:600;font-size:0.95rem;cursor:pointer;transition:all 0.2s;border:none}
        .btn-primary{background:var(--accent);color:white}
        .btn-primary:hover{background:var(--accent-hover)}
        .btn-secondary{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border)}
        .btn-secondary:hover{background:var(--border);color:var(--text-primary)}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        /* Leak Reveal */
        .leak-reveal{background:var(--accent-light);border:1px solid rgba(239,68,68,0.3);border-radius:0.75rem;padding:1rem;margin-top:1rem;display:none}
        .leak-reveal.active{display:block;animation:fadeIn 0.3s ease}
        .leak-reveal .leak-amount{font-size:1.3rem;font-weight:700;color:var(--accent)}
        .leak-reveal .leak-desc{font-size:0.85rem;color:var(--text-secondary);margin-top:0.25rem}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* Results */
        .results-page{display:none}
        .results-page.active{display:block;animation:fadeIn 0.4s ease}
        .total-card{background:var(--bg-secondary);border:2px solid var(--accent);border-radius:1rem;padding:2.5rem;text-align:center;margin-bottom:2rem}
        .total-card .reveal-text{font-size:1rem;color:var(--text-secondary);margin-bottom:0.5rem}
        .total-card .total-amount{font-size:3.5rem;font-weight:700;color:var(--accent);line-height:1}
        .total-card .total-sub{font-size:1rem;color:var(--text-muted);margin-top:0.5rem}
        .total-card .total-context{color:var(--text-secondary);margin-top:1rem;font-size:0.95rem}
        .leaks-breakdown{background:var(--bg-secondary);border:1px solid var(--border);border-radius:1rem;padding:2rem;margin-bottom:2rem}
        .leaks-breakdown h3{font-size:1.1rem;margin-bottom:1.25rem}
        .leak-row{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid var(--border)}
        .leak-row:last-child{border-bottom:none}
        .leak-row .name{font-size:0.9rem;color:var(--text-secondary)}
        .leak-row .val{font-size:1rem;font-weight:600;color:var(--accent)}
        .leak-bar-container{flex:1;height:8px;background:var(--bg-tertiary);border-radius:9999px;margin:0 1rem;overflow:hidden}
        .leak-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:9999px}
        /* Download Section */
        .download-section{background:linear-gradient(135deg,var(--accent-light),var(--bg-secondary));border:2px solid var(--accent);border-radius:1rem;padding:2.5rem;text-align:center;margin-bottom:2rem}
        .download-section h3{font-size:1.4rem;margin-bottom:0.5rem}
        .download-section>p{color:var(--text-secondary);margin-bottom:1.5rem}
        .download-features{display:flex;justify-content:center;gap:1.5rem;margin-bottom:1.5rem;flex-wrap:wrap}
        .download-feature{display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;color:var(--text-secondary)}
        .download-feature .icon{color:var(--success)}
        .email-form{display:flex;gap:0.75rem;max-width:450px;margin:0 auto;flex-wrap:wrap}
        .email-form input[type="email"]{flex:1;min-width:200px;padding:0.875rem 1rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-size:1rem}
        .email-form input:focus{outline:none;border-color:var(--accent)}
        .email-form .btn{flex:none;min-width:180px}
        .download-complete{display:none;color:var(--success);padding:1rem;font-size:1rem}
        .download-complete.active{display:block}
        footer{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.875rem}
        footer a{color:var(--accent);text-decoration:none}
        @media(max-width:640px){.container{padding:1rem}h1{font-size:1.65rem}.total-card .total-amount{font-size:2.5rem}.running-total .amount{font-size:1.3rem}}
    </style>
</head>
<body>
<div class="container">
    <header>
        <span class="badge">Free Diagnostic</span>
        <h1>The $100K You Don't Know You're Losing</h1>
        <p class="subtitle">Answer 8 questions about your operations. We'll calculate exactly how much profit is silently leaking from your distribution business.</p>
    </header>
    <div class="progress-container" id="progressContainer">
        <div class="progress-header">
            <span class="progress-label">Diagnostic Progress</span>
            <span class="progress-count"><span id="currentQ">1</span> of <span id="totalQ">8</span></span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:12.5%"></div></div>
    </div>
    <div class="running-total" id="runningTotal">
        <span class="label">üí∏ Estimated Annual Profit Leakage</span>
        <span class="amount" id="runningAmount">$0</span>
    </div>
    <div id="questionsContainer"></div>
    <div class="results-page" id="resultsPage">
        <div class="total-card">
            <div class="reveal-text">Your distribution business is silently losing an estimated</div>
            <div class="total-amount" id="finalTotal">$0</div>
            <div class="total-sub">per year</div>
            <div class="total-context" id="totalContext"></div>
        </div>
        <div class="leaks-breakdown">
            <h3>Where It's Going</h3>
            <div id="leaksBreakdown"></div>
        </div>
        <div class="download-section" id="downloadSection">
            <h3>üìÑ Get Your Full Profit Recovery Plan</h3>
            <p>Download a detailed PDF showing exactly how to plug each leak, with implementation timelines and projected ROI.</p>
            <div class="download-features">
                <div class="download-feature"><span class="icon">‚úì</span><span>Fix-by-fix action plan</span></div>
                <div class="download-feature"><span class="icon">‚úì</span><span>ROI per improvement</span></div>
                <div class="download-feature"><span class="icon">‚úì</span><span>Priority ranking</span></div>
            </div>
            <form class="email-form" id="emailForm" onsubmit="handleDownload(event)">
                <input type="email" id="userEmail" placeholder="Enter your work email" required>
                <button type="submit" class="btn btn-primary">üì• Download PDF</button>
            </form>
            <div class="download-complete" id="downloadComplete">‚úì Report downloaded! Check your downloads folder.</div>
        </div>
    </div>
    <footer><p>Built by <a href="#">Mo Roowala</a> | AI Automation for Distributors</p></footer>
</div>
<script>
const { jsPDF } = window.jspdf;

const steps = [
    {
        category: "Revenue",
        question: "What is your approximate annual revenue?",
        hint: "This helps us calculate dollar amounts specific to your business.",
        inputs: [
            { id: "revenue", label: "Annual Revenue", type: "number", placeholder: "e.g., 25000000", unit: "$" }
        ],
        calc: (vals) => ({ leak: 0, label: "Baseline", desc: "" })
    },
    {
        category: "Pricing",
        question: "How do your sales reps handle pricing?",
        hint: "Inconsistent pricing is the #1 profit leak in distribution. A 1% price reduction can wipe out 11% of profit.",
        inputs: [
            { id: "pricingMethod", label: "Primary pricing method", type: "select", options: [
                { value: "gut", text: "Reps decide based on gut/experience" },
                { value: "lists", text: "Price lists exist but lots of exceptions" },
                { value: "system", text: "System-driven with clear rules" }
            ]},
            { id: "overridesPerWeek", label: "Price overrides or exceptions per week", type: "number", placeholder: "e.g., 15", unit: "/week" }
        ],
        calc: (vals) => {
            const rev = parseFloat(vals.revenue) || 0;
            const method = vals.pricingMethod;
            const overrides = parseFloat(vals.overridesPerWeek) || 0;
            let leakPct = method === 'gut' ? 0.01 : method === 'lists' ? 0.006 : 0.002;
            leakPct += (overrides * 0.0003);
            const leak = Math.round(rev * leakPct);
            return { leak, label: "Pricing Inconsistency", desc: `${overrides} overrides/week at ~${(leakPct*100).toFixed(2)}% revenue impact` };
        }
    },
    {
        category: "Order Processing",
        question: "How many orders does your team process per day, and how?",
        hint: "Manual order entry costs $5-15 per order in labor. Errors cost 10-20x more to fix.",
        inputs: [
            { id: "ordersPerDay", label: "Orders processed per day", type: "number", placeholder: "e.g., 50", unit: "/day" },
            { id: "manualPct", label: "% entered manually (from email/phone)", type: "number", placeholder: "e.g., 70", unit: "%" },
            { id: "errorRate", label: "Estimated error rate", type: "number", placeholder: "e.g., 3", unit: "%" }
        ],
        calc: (vals) => {
            const orders = parseFloat(vals.ordersPerDay) || 0;
            const manual = (parseFloat(vals.manualPct) || 0) / 100;
            const errorRate = (parseFloat(vals.errorRate) || 0) / 100;
            const manualCostPerOrder = 5;
            const errorCostPerOrder = 85;
            const yearlyOrders = orders * 260;
            const manualCost = Math.round(yearlyOrders * manual * manualCostPerOrder);
            const errorCost = Math.round(yearlyOrders * errorRate * errorCostPerOrder);
            const leak = manualCost + errorCost;
            return { leak, label: "Order Processing Waste", desc: `${Math.round(yearlyOrders*manual).toLocaleString()} manual entries + ${Math.round(yearlyOrders*errorRate).toLocaleString()} errors/year` };
        }
    },
    {
        category: "Quoting",
        question: "How long does it take to turn around a quote?",
        hint: "Every hour of delay on a quote reduces win rate by 2-5%. Speed to quote is speed to revenue.",
        inputs: [
            { id: "quotesPerWeek", label: "Quotes sent per week", type: "number", placeholder: "e.g., 30", unit: "/week" },
            { id: "quoteHours", label: "Average hours to send a quote", type: "number", placeholder: "e.g., 4", unit: "hours" },
            { id: "avgQuoteValue", label: "Average quote value", type: "number", placeholder: "e.g., 5000", unit: "$" }
        ],
        calc: (vals) => {
            const quotes = parseFloat(vals.quotesPerWeek) || 0;
            const hours = parseFloat(vals.quoteHours) || 0;
            const value = parseFloat(vals.avgQuoteValue) || 0;
            const lostPct = Math.min(hours * 0.02, 0.15);
            const yearlyQuotes = quotes * 52;
            const leak = Math.round(yearlyQuotes * value * lostPct * 0.15);
            return { leak, label: "Slow Quote Response", desc: `${hours}hr avg turnaround losing ~${(lostPct*100).toFixed(0)}% of winnable deals` };
        }
    },
    {
        category: "Inventory",
        question: "How accurate is your inventory, and how often do you have stockouts?",
        hint: "The average distributor has 20-30% excess inventory and 5-10% stockout rate.",
        inputs: [
            { id: "inventoryValue", label: "Total inventory value", type: "number", placeholder: "e.g., 3000000", unit: "$" },
            { id: "stockoutPct", label: "Estimated stockout rate (% of orders)", type: "number", placeholder: "e.g., 5", unit: "%" },
            { id: "excessPct", label: "Estimated excess/dead stock (%)", type: "number", placeholder: "e.g., 15", unit: "%" }
        ],
        calc: (vals) => {
            const rev = parseFloat(vals.revenue) || 0;
            const inv = parseFloat(vals.inventoryValue) || 0;
            const stockout = (parseFloat(vals.stockoutPct) || 0) / 100;
            const excess = (parseFloat(vals.excessPct) || 0) / 100;
            const stockoutLoss = Math.round(rev * stockout * 0.15);
            const carryingCost = Math.round(inv * excess * 0.25);
            const leak = stockoutLoss + carryingCost;
            return { leak, label: "Inventory Mismanagement", desc: `$${stockoutLoss.toLocaleString()} lost sales + $${carryingCost.toLocaleString()} carrying cost` };
        }
    },
    {
        category: "Customer Retention",
        question: "What does customer churn look like for you?",
        hint: "Acquiring a new customer costs 5-7x more than retaining one. Most distributors don't track churn.",
        inputs: [
            { id: "totalCustomers", label: "Active customers", type: "number", placeholder: "e.g., 200", unit: "" },
            { id: "churnPct", label: "% of customers lost per year", type: "number", placeholder: "e.g., 10", unit: "%" },
            { id: "avgCustomerValue", label: "Average annual customer value", type: "number", placeholder: "e.g., 50000", unit: "$" }
        ],
        calc: (vals) => {
            const customers = parseFloat(vals.totalCustomers) || 0;
            const churn = (parseFloat(vals.churnPct) || 0) / 100;
            const acv = parseFloat(vals.avgCustomerValue) || 0;
            const preventable = 0.2;
            const leak = Math.round(customers * churn * acv * preventable);
            return { leak, label: "Preventable Customer Churn", desc: `${Math.round(customers*churn)} customers lost/year, ~30% preventable with automation` };
        }
    },
    {
        category: "Labor",
        question: "How much time does your team spend on tasks that should be automated?",
        hint: "The average distributor employee spends 40% of their time on repetitive manual tasks.",
        inputs: [
            { id: "employeeCount", label: "Number of office/admin employees", type: "number", placeholder: "e.g., 12", unit: "" },
            { id: "avgSalary", label: "Average annual salary", type: "number", placeholder: "e.g., 55000", unit: "$" },
            { id: "manualTimePct", label: "% of time on repetitive manual work", type: "number", placeholder: "e.g., 35", unit: "%" }
        ],
        calc: (vals) => {
            const count = parseFloat(vals.employeeCount) || 0;
            const salary = parseFloat(vals.avgSalary) || 0;
            const manual = (parseFloat(vals.manualTimePct) || 0) / 100;
            const automatable = 0.4;
            const leak = Math.round(count * salary * manual * automatable);
            return { leak, label: "Wasted Labor Hours", desc: `${count} employees x ${(manual*100).toFixed(0)}% manual time x 60% automatable` };
        }
    },
    {
        category: "Supplier",
        question: "How do you handle supplier price changes?",
        hint: "Most distributors take 2-4 weeks to pass through supplier increases. Every day of delay erodes margin.",
        inputs: [
            { id: "priceChangesYear", label: "Supplier price changes per year", type: "number", placeholder: "e.g., 50", unit: "/year" },
            { id: "daysToUpdate", label: "Average days to update your prices", type: "number", placeholder: "e.g., 14", unit: "days" },
            { id: "avgChangeImpact", label: "Avg revenue affected per change", type: "number", placeholder: "e.g., 100000", unit: "$" }
        ],
        calc: (vals) => {
            const changes = parseFloat(vals.priceChangesYear) || 0;
            const days = parseFloat(vals.daysToUpdate) || 0;
            const impact = parseFloat(vals.avgChangeImpact) || 0;
            const dailyMarginLoss = 0.0003;
            const leak = Math.round(changes * days * impact * dailyMarginLoss);
            return { leak, label: "Slow Price Pass-Through", desc: `${days} day avg delay across ${changes} changes/year` };
        }
    }
];

let currentStep = 0;
let allValues = {};
let leaks = [];
let runningLeak = 0;

function init() {
    document.getElementById('totalQ').textContent = steps.length;
    renderStep(0);
}

function renderStep(idx) {
    const s = steps[idx];
    const container = document.getElementById('questionsContainer');
    let html = `<div class="q-card active">
        <span class="q-category">${s.category}</span>
        <h2 class="q-text">${s.question}</h2>
        <p class="q-hint">${s.hint}</p>`;

    s.inputs.forEach(inp => {
        html += `<div class="input-group"><label for="${inp.id}">${inp.label}</label>`;
        if (inp.type === 'select') {
            html += `<select id="${inp.id}">`;
            inp.options.forEach(o => {
                const sel = allValues[inp.id] === o.value ? 'selected' : '';
                html += `<option value="${o.value}" ${sel}>${o.text}</option>`;
            });
            html += `</select>`;
        } else {
            const val = allValues[inp.id] || '';
            if (inp.unit && inp.unit !== '') {
                html += `<div class="input-row"><input type="number" id="${inp.id}" placeholder="${inp.placeholder}" value="${val}" min="0" step="any">
                    <span class="unit">${inp.unit}</span></div>`;
            } else {
                html += `<div class="input-row"><input type="number" id="${inp.id}" placeholder="${inp.placeholder}" value="${val}" min="0" step="any">
                    <span class="unit">#</span></div>`;
            }
        }
        html += `</div>`;
    });

    html += `<div class="leak-reveal" id="leakReveal"></div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="prevStep()" ${idx===0?'disabled':''}>‚Üê Back</button>
            <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">${idx===steps.length-1?'See Full Results':'Next ‚Üí'}</button>
        </div></div>`;

    container.innerHTML = html;
    document.getElementById('currentQ').textContent = idx + 1;
    document.getElementById('progressFill').style.width = ((idx+1)/steps.length*100) + '%';
}

function saveCurrentInputs() {
    const s = steps[currentStep];
    s.inputs.forEach(inp => {
        const el = document.getElementById(inp.id);
        if (el) allValues[inp.id] = el.value;
    });
}

function nextStep() {
    saveCurrentInputs();

    // Calculate leak for current step
    if (currentStep > 0 || steps[currentStep].calc) {
        const result = steps[currentStep].calc(allValues);
        if (result.leak > 0) {
            leaks[currentStep] = result;
            recalcTotal();
        }
    }

    if (currentStep < steps.length - 1) {
        currentStep++;
        renderStep(currentStep);
    } else {
        showResults();
    }
}

function prevStep() {
    saveCurrentInputs();
    if (currentStep > 0) {
        currentStep--;
        renderStep(currentStep);
    }
}

function recalcTotal() {
    runningLeak = leaks.reduce((sum, l) => sum + (l ? l.leak : 0), 0);
    const el = document.getElementById('runningAmount');
    el.textContent = '$' + runningLeak.toLocaleString();
    el.style.transform = 'scale(1.1)';
    setTimeout(() => el.style.transform = 'scale(1)', 200);
}

function showResults() {
    document.getElementById('questionsContainer').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'none';
    document.getElementById('runningTotal').style.display = 'none';
    document.getElementById('resultsPage').classList.add('active');

    const total = runningLeak;
    document.getElementById('finalTotal').textContent = '$' + total.toLocaleString();

    const rev = parseFloat(allValues.revenue) || 1;
    const pctOfRev = ((total / rev) * 100).toFixed(1);
    const perMonth = Math.round(total / 12).toLocaleString();
    const perDay = Math.round(total / 365).toLocaleString();
    document.getElementById('totalContext').innerHTML =
        `That's <strong>${pctOfRev}% of your revenue</strong>. $${perMonth} per month. $${perDay} every single day. Most of it is recoverable.`;

    // Breakdown
    const validLeaks = leaks.filter(l => l && l.leak > 0).sort((a, b) => b.leak - a.leak);
    const maxLeak = validLeaks[0]?.leak || 1;
    document.getElementById('leaksBreakdown').innerHTML = validLeaks.map(l => `
        <div class="leak-row">
            <span class="name" style="min-width:140px">${l.label}</span>
            <div class="leak-bar-container"><div class="leak-bar" style="width:${(l.leak/maxLeak*100)}%"></div></div>
            <span class="val">$${l.leak.toLocaleString()}</span>
        </div>
    `).join('');
}

function handleDownload(e) {
    e.preventDefault();
    const email = document.getElementById('userEmail').value;
    const leads = JSON.parse(localStorage.getItem('profitleak_leads') || '[]');
    leads.push({ email, timestamp: new Date().toISOString(), total: runningLeak, leaks, inputs: allValues });
    localStorage.setItem('profitleak_leads', JSON.stringify(leads));
    generatePDF(email);
    document.getElementById('emailForm').style.display = 'none';
    document.getElementById('downloadComplete').classList.add('active');
}

function generatePDF(email) {
    const doc = new jsPDF();
    const pw = doc.internal.pageSize.getWidth();
    const m = 20;
    const cw = pw - 2 * m;
    let y = 0;

    const txt = (text, size, style='normal', color=[52,52,56]) => {
        doc.setFontSize(size);
        doc.setFont('helvetica', style);
        doc.setTextColor(...color);
    };
    const addBg = () => { doc.setFillColor(236,233,228); doc.rect(0,0,pw,297,'F'); };
    const checkPage = (need=25) => { if(y+need>268){doc.addPage();addBg();y=18;} };

    // ---- PAGE 1: COVER ----
    addBg();
    doc.setFillColor(30, 30, 42);
    doc.rect(0, 0, pw, 48, 'F');
    txt('PROFIT LEAK DIAGNOSTIC', 20, 'bold', [255,255,255]);
    doc.text('PROFIT LEAK DIAGNOSTIC', pw/2, 18, {align:'center'});
    txt('Your Personalized Recovery Plan', 10, 'normal', [180,180,200]);
    doc.text('Your Personalized Recovery Plan', pw/2, 28, {align:'center'});
    txt(`${email} | ${new Date().toLocaleDateString()}`, 8, 'normal', [140,140,160]);
    doc.text(`${email} | ${new Date().toLocaleDateString()}`, pw/2, 38, {align:'center'});

    y = 58;

    // Total
    doc.setFillColor(255, 245, 245);
    doc.roundedRect(m, y, cw, 40, 3, 3, 'F');
    doc.setDrawColor(239, 68, 68);
    doc.roundedRect(m, y, cw, 40, 3, 3, 'S');
    txt('YOUR ESTIMATED ANNUAL PROFIT LEAKAGE', 10, 'bold', [239,68,68]);
    doc.text('YOUR ESTIMATED ANNUAL PROFIT LEAKAGE', pw/2, y+12, {align:'center'});
    txt('$' + runningLeak.toLocaleString(), 28, 'bold', [239,68,68]);
    doc.text('$' + runningLeak.toLocaleString(), pw/2, y+28, {align:'center'});
    const rev = parseFloat(allValues.revenue) || 1;
    txt(`${((runningLeak/rev)*100).toFixed(1)}% of your annual revenue`, 10, 'normal', [100,100,100]);
    doc.text(`${((runningLeak/rev)*100).toFixed(1)}% of your annual revenue`, pw/2, y+37, {align:'center'});

    y += 55;

    // Breakdown chart
    txt('WHERE YOUR PROFIT IS LEAKING', 14, 'bold', [48,48,52]);
    doc.text('WHERE YOUR PROFIT IS LEAKING', m, y);
    y += 10;

    const validLeaks = leaks.filter(l => l && l.leak > 0).sort((a, b) => b.leak - a.leak);
    const maxLeak = validLeaks[0]?.leak || 1;

    validLeaks.forEach(l => {
        checkPage(18);
        const barWidth = (l.leak / maxLeak) * (cw - 80);

        txt(l.label, 9, 'bold', [58,58,62]);
        doc.text(l.label, m, y + 4);
        txt('$' + l.leak.toLocaleString(), 9, 'bold', [239,68,68]);
        doc.text('$' + l.leak.toLocaleString(), pw - m, y + 4, {align:'right'});

        doc.setFillColor(245, 230, 230);
        doc.roundedRect(m, y + 7, cw, 5, 2, 2, 'F');
        doc.setFillColor(239, 68, 68);
        doc.roundedRect(m, y + 7, Math.max(barWidth, 3), 5, 2, 2, 'F');

        txt(l.desc, 7, 'normal', [120,120,120]);
        doc.text(l.desc, m, y + 18);
        y += 23;
    });

    y += 10;

    // ---- DETAILED FIX PLANS ----
    const fixes = {
        "Pricing Inconsistency": {
            priority: "CRITICAL",
            impact: "Typically recovers 1-3% of revenue",
            steps: [
                "Week 1: Audit last 90 days of pricing. Pull every quote and compare margins across same SKUs, same customer tiers.",
                "Week 2: Identify your top 50 SKUs by volume. Set floor prices and target margins for each.",
                "Week 3-4: Create a pricing matrix by customer tier (A/B/C) and volume break. Document the rules.",
                "Week 5-6: Implement approval workflow. Any quote below floor requires manager approval with a documented reason.",
                "Week 7-8: Configure your ERP's pricing module (most have one that's underused). Automate the matrix.",
                "Month 3: Review pricing compliance weekly. Track override frequency and margin impact."
            ],
            roi: "3-5x return in first year. One distributor recovered $101,700 annually on $32M revenue."
        },
        "Order Processing Waste": {
            priority: "HIGH",
            impact: "Reduces labor cost 30-50% and errors 70%+",
            steps: [
                "Week 1: Time-study your order entry process. Document every step from email received to order in system.",
                "Week 2: Categorize orders by complexity. Most distributors find 60-80% follow standard patterns.",
                "Week 3-4: Set up email parsing rules or basic automation for standard orders.",
                "Week 5-6: Implement order validation rules in your ERP to catch errors before they ship.",
                "Week 7-8: Create customer self-service portal for top 20 accounts (they prefer it).",
                "Month 3: Measure error rate weekly. Target 70% reduction in order corrections."
            ],
            roi: "Typical payback in 4-6 months. Most savings come from error reduction, not just speed."
        },
        "Slow Quote Response": {
            priority: "HIGH",
            impact: "Increases quote-to-close rate 15-25%",
            steps: [
                "Week 1: Measure current quote turnaround. Track from 'request received' to 'quote sent'. Be honest.",
                "Week 2: Create templates for your 10 most common quote types. Pre-populate pricing.",
                "Week 3-4: Implement a quoting tool or configure your ERP's quote module with templates and auto-pricing.",
                "Week 5-6: Set response time targets. Same-day for standard quotes, 24hr for complex.",
                "Week 7-8: Add automated follow-up. If a quote isn't responded to in 3 days, trigger a reminder.",
                "Month 3: Track win rate by response time. You'll see the correlation immediately."
            ],
            roi: "Every hour shaved off response time increases win rate 2-5%. On high-value quotes, this is massive."
        },
        "Inventory Mismanagement": {
            priority: "HIGH",
            impact: "Reduces carrying costs 20-30%, stockouts 50%+",
            steps: [
                "Week 1: Run an ABC analysis. Classify inventory by annual revenue contribution (A=top 80%, B=next 15%, C=bottom 5%).",
                "Week 2: Calculate reorder points for all A items. Use: (avg daily usage x lead time) + safety stock.",
                "Week 3-4: Set up automatic reorder alerts in your ERP for A items. Many systems have this built-in.",
                "Week 5-6: Identify dead stock (no movement in 12+ months). Create a liquidation plan.",
                "Week 7-8: Implement cycle counting instead of annual full counts. Count A items monthly, B quarterly, C annually.",
                "Month 3: Review fill rate and stockout metrics weekly. Target 95%+ fill rate."
            ],
            roi: "Reducing excess inventory by 10% frees significant working capital. Reducing stockouts directly recovers lost sales."
        },
        "Preventable Customer Churn": {
            priority: "MEDIUM",
            impact: "Retaining just 5% more customers can increase profit 25-95%",
            steps: [
                "Week 1: Pull a list of customers who ordered last year but not this year. This is your 'silent churn' list.",
                "Week 2: Call the top 10 churned customers. Ask what happened. Document every answer.",
                "Week 3-4: Identify the top 3 churn reasons. Common: price, service speed, stockouts, competitor poached them.",
                "Week 5-6: Set up automated 'at risk' alerts. If an A or B customer's order frequency drops 30%, flag them.",
                "Week 7-8: Create a customer health dashboard. Track order frequency, average order value, and complaints.",
                "Month 3: Implement quarterly business reviews with top 20 accounts. Proactive beats reactive."
            ],
            roi: "Customer retention has the highest ROI of any business activity. One saved $50K account pays for the entire program."
        },
        "Wasted Labor Hours": {
            priority: "MEDIUM",
            impact: "Frees 20-40% of admin time for higher-value work",
            steps: [
                "Week 1: Survey your team. Ask: 'What tasks do you do every day that feel like a waste of time?' You'll get gold.",
                "Week 2: Rank tasks by frequency and time consumed. The top 5 are your automation targets.",
                "Week 3-4: Implement quick wins first (email templates, auto-reports, standardized forms).",
                "Week 5-6: Evaluate RPA (Robotic Process Automation) for high-volume repetitive tasks like data entry.",
                "Week 7-8: Redeploy freed-up time to customer-facing activities. More selling, less admin.",
                "Month 3: Measure hours saved per employee per week. Celebrate and share wins internally."
            ],
            roi: "Even freeing 5 hours per employee per week across 10 employees = 2,600 hours/year of recovered capacity."
        },
        "Slow Price Pass-Through": {
            priority: "MEDIUM",
            impact: "Protects margin during supplier increase cycles",
            steps: [
                "Week 1: List all supplier price changes in the last 12 months. Note how many days between their change and yours.",
                "Week 2: Create a price change playbook. When supplier notifies, who does what, in what order?",
                "Week 3-4: Set up a supplier price monitoring system. Even a shared spreadsheet with alerts is better than email chains.",
                "Week 5-6: Pre-calculate customer price adjustments. Build formulas that auto-calculate new prices when supplier costs change.",
                "Week 7-8: Implement automated customer notifications for price changes. Professional and fast.",
                "Month 3: Target same-week pass-through for all supplier changes. Track days-to-update as a KPI."
            ],
            roi: "Every day of delay costs margin. Cutting pass-through time from 14 days to 2 days can recover tens of thousands annually."
        }
    };

    // Fix plans
    doc.addPage();
    y = 20;
    txt('DETAILED RECOVERY PLAN', 18, 'bold', [239,68,68]);
    doc.text('DETAILED RECOVERY PLAN', pw/2, y, {align:'center'});
    y += 5;
    txt('Prioritized actions to recover your lost profit', 10, 'normal', [100,100,100]);
    doc.text('Prioritized actions to recover your lost profit', pw/2, y + 5, {align:'center'});
    y += 18;

    validLeaks.forEach((leak, idx) => {
        const fix = fixes[leak.label];
        if (!fix) return;

        checkPage(90);

        // Section header
        const priorityColors = { CRITICAL: [239,68,68], HIGH: [245,158,11], MEDIUM: [99,102,241] };
        const pColor = priorityColors[fix.priority] || [100,100,100];

        doc.setFillColor(...pColor);
        doc.roundedRect(m, y, cw, 10, 2, 2, 'F');
        txt(`#${idx+1}: ${leak.label.toUpperCase()}`, 11, 'bold', [255,255,255]);
        doc.text(`#${idx+1}: ${leak.label.toUpperCase()}`, m + 5, y + 7);
        txt(`$${leak.leak.toLocaleString()}/yr`, 11, 'bold', [255,255,255]);
        doc.text(`$${leak.leak.toLocaleString()}/yr`, pw - m - 5, y + 7, {align:'right'});
        y += 15;

        // Priority and Impact
        txt(`Priority: ${fix.priority}`, 9, 'bold', pColor);
        doc.text(`Priority: ${fix.priority}`, m, y);
        y += 5;
        txt(`Expected Impact: ${fix.impact}`, 9, 'normal', [82,82,85]);
        doc.text(`Expected Impact: ${fix.impact}`, m, y);
        y += 8;

        // Steps
        txt('ACTION STEPS:', 9, 'bold', [58,58,62]);
        doc.text('ACTION STEPS:', m, y);
        y += 5;

        fix.steps.forEach((step, i) => {
            checkPage(15);
            txt(step, 8, 'normal', [75,75,78]);
            const lines = doc.splitTextToSize(step, cw - 5);
            doc.text(lines, m + 3, y);
            y += lines.length * 4 + 3;
        });

        // ROI
        checkPage(15);
        doc.setFillColor(245, 250, 245);
        const roiLines = doc.splitTextToSize(`ROI: ${fix.roi}`, cw - 10);
        doc.roundedRect(m, y, cw, roiLines.length * 4.5 + 8, 2, 2, 'F');
        txt(`ROI: ${fix.roi}`, 8, 'bold', [34,100,34]);
        doc.text(roiLines, m + 5, y + 6);
        y += roiLines.length * 4.5 + 15;
    });

    // ---- 90-DAY ROADMAP ----
    checkPage(80);
    doc.addPage();
    y = 20;
    txt('YOUR 90-DAY PROFIT RECOVERY ROADMAP', 16, 'bold', [239,68,68]);
    doc.text('YOUR 90-DAY PROFIT RECOVERY ROADMAP', pw/2, y, {align:'center'});
    y += 15;

    const phases = [
        { title: 'DAYS 1-14: QUICK WINS', color: [34,197,94], items: [
            'Audit pricing on top 50 SKUs. Set floor prices immediately.',
            'Call top 10 churned customers. Document why they left.',
            'Survey employees on biggest time-wasters.',
            'Measure current quote turnaround and order error rate.'
        ]},
        { title: 'DAYS 15-30: FOUNDATIONS', color: [245,158,11], items: [
            'Build pricing matrix by customer tier and volume.',
            'Create quote templates for top 10 quote types.',
            'Run ABC analysis on inventory. Set reorder points for A items.',
            'Implement approval workflow for below-floor pricing.'
        ]},
        { title: 'DAYS 31-60: AUTOMATION', color: [99,102,241], items: [
            'Configure ERP pricing module with your matrix and rules.',
            'Set up order validation and automated alerts.',
            'Deploy automated reorder point notifications.',
            'Implement customer health monitoring dashboard.'
        ]},
        { title: 'DAYS 61-90: OPTIMIZATION', color: [139,92,246], items: [
            'Review all KPIs: error rate, quote speed, margin, fill rate.',
            'Fine-tune automation rules based on real-world results.',
            'Expand automation to B-tier items and processes.',
            'Calculate actual recovered profit. Celebrate wins with team.'
        ]}
    ];

    phases.forEach(phase => {
        checkPage(45);
        doc.setFillColor(...phase.color);
        doc.roundedRect(m, y, cw, 8, 2, 2, 'F');
        txt(phase.title, 10, 'bold', [255,255,255]);
        doc.text(phase.title, m + 4, y + 6);
        y += 13;

        phase.items.forEach(item => {
            checkPage(12);
            txt(item, 9, 'normal', [65,65,68]);
            const lines = doc.splitTextToSize('‚Ä¢ ' + item, cw - 10);
            doc.text(lines, m + 5, y);
            y += lines.length * 4.5 + 2;
        });
        y += 8;
    });

    // ---- TOTAL RECOVERY PROJECTION ----
    checkPage(50);
    y += 5;
    doc.setFillColor(255, 245, 245);
    doc.roundedRect(m, y, cw, 35, 3, 3, 'F');
    doc.setDrawColor(239, 68, 68);
    doc.roundedRect(m, y, cw, 35, 3, 3, 'S');

    txt('PROJECTED ANNUAL RECOVERY', 12, 'bold', [239,68,68]);
    doc.text('PROJECTED ANNUAL RECOVERY', pw/2, y + 10, {align:'center'});

    const conservative = Math.round(runningLeak * 0.3);
    const moderate = Math.round(runningLeak * 0.5);
    const aggressive = Math.round(runningLeak * 0.7);

    txt(`Conservative (30%): $${conservative.toLocaleString()}   |   Moderate (50%): $${moderate.toLocaleString()}   |   Aggressive (70%): $${aggressive.toLocaleString()}`, 9, 'normal', [82,82,85]);
    doc.text(`Conservative (30%): $${conservative.toLocaleString()}  |  Moderate (50%): $${moderate.toLocaleString()}  |  Aggressive (70%): $${aggressive.toLocaleString()}`, pw/2, y + 20, {align:'center'});

    txt('Most distributors achieve moderate recovery within 6-12 months of starting.', 8, 'normal', [120,120,120]);
    doc.text('Most distributors achieve moderate recovery within 6-12 months of starting.', pw/2, y + 28, {align:'center'});

    y += 45;

    // ---- CTA ----
    checkPage(40);
    doc.setFillColor(30, 30, 42);
    doc.roundedRect(m, y, cw, 35, 3, 3, 'F');

    txt("LET'S RECOVER YOUR PROFIT", 13, 'bold', [255,255,255]);
    doc.text("LET'S RECOVER YOUR PROFIT", pw/2, y + 11, {align:'center'});

    txt("You now know where the money is going. Let's build a plan to get it back.", 9, 'normal', [180,180,200]);
    doc.text("You now know where the money is going. Let's build a plan to get it back.", pw/2, y + 20, {align:'center'});

    txt('mo@deeplineop.ai', 12, 'bold', [245,200,80]);
    doc.text('mo@deeplineop.ai', pw/2, y + 30, {align:'center'});

    // Footer on every page
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFillColor(30, 30, 42);
        doc.rect(0, 287, pw, 10, 'F');
        txt('Mo Roowala | Deep Line Operations | AI Automation for Distributors', 7, 'normal', [130,130,150]);
        doc.text('Mo Roowala | Deep Line Operations | AI Automation for Distributors', pw/2, 292, {align:'center'});
    }

    doc.save('Profit-Leak-Diagnostic-Report.pdf');
}

init();
</script>
</body>
</html>
